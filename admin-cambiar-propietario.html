<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambiar Propietario - Nexxos Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-sidebar.css">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.85rem;
            color: #555;
        }



        .page-title {
            color: #5b9bd5;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .card-form {
            background: white;
            padding: 30px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .form-label {
            font-weight: 600;
            color: #333;
            font-size: 0.85rem;
        }

        .required {
            color: #dc3545;
        }

        .section-header {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Toggles estilo Nexxos (Cuadrados Si/No) */
        .btn-group-toggle .btn {
            font-size: 0.8rem;
            padding: 5px 20px;
        }

        .btn-check:checked+.btn-primary {
            background-color: #5b9bd5;
            border-color: #5b9bd5;
        }

        .btn-check:checked+.btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }

        /* Caja de Atención Azul */
        .alert-info-custom {
            background-color: #e3f2fd;
            border-left: 4px solid #5b9bd5;
            color: #0d47a1;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-brand">
            <img src="Logo_MG.jpeg" alt="Logo MG">
            <div>ADMIN</div>
        </div>
        <a href="admin-dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
        <a href="admin-propiedades.html" class="active"><i class="bi bi-house-door me-2"></i> Propiedades</a>
        <a href="admin-publicar-3.html"><i class="bi bi-plus-circle me-2"></i> Publicar</a>
        <a href="admin-interesados.html"><i class="bi bi-people me-2"></i> Interesados / Leads</a>
        <a href="admin-agenda-2.html"><i class="bi bi-calendar-check me-2"></i> Agenda</a>
        <a href="admin-reportes.html"><i class="bi bi-bar-chart me-2"></i> Reportes</a>
        <a href="admin-marketing-ai.html"><i class="bi bi-stars me-2"></i> Marketing IA</a>
        <div class="mt-auto p-3">
            <a href="index.html" class="d-flex align-items-center text-white-50 text-decoration-none">
                <i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión
            </a>
        </div>
    </div>

    <div class="main-content">
        <h4 class="page-title"><i class="bi bi-house-door-fill"></i> DATOS DEL PROPIETARIO <span id="header_cod"
                class="text-muted fw-normal ms-2"></span></h4>

        <div class="card-form">

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Nº documento (RUT ó pasaporte) <span class="required">*</span></label>
                    <input type="text" class="form-control" id="rut">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Tipo de documento <span class="required">*</span></label>
                    <div class="mt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoDoc" value="RUT" checked>
                            <label class="form-check-label">RUT</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="tipoDoc" value="Pasaporte">
                            <label class="form-check-label">Pasaporte</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">Nombre <span class="required">*</span></label>
                <input type="text" class="form-control" id="nombre">
            </div>

            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label class="form-label">Apellido paterno <span class="required">*</span></label>
                    <input type="text" class="form-control" id="apellidoP">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Apellido materno</label>
                    <input type="text" class="form-control" id="apellidoM">
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label">Correo electrónico <span class="required">*</span></label>
                <input type="email" class="form-control" id="email">
            </div>

            <h5 class="section-header">Datos de contacto</h5>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label class="form-label">Tfno. particular</label>
                    <input type="text" class="form-control" id="fono_fijo">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Celular</label>
                    <input type="text" class="form-control" id="celular">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Tfno. comercial</label>
                    <input type="text" class="form-control" id="fono_comercial">
                </div>
            </div>

            <h5 class="section-header">Estado, Tipo e Interés</h5>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label d-block">Activo</label>
                    <div class="btn-group btn-group-toggle" role="group">
                        <input type="radio" class="btn-check" name="activo" id="actSi" value="Si" checked>
                        <label class="btn btn-outline-primary" for="actSi">Sí</label>
                        <input type="radio" class="btn-check" name="activo" id="actNo" value="No">
                        <label class="btn btn-outline-secondary" for="actNo">No</label>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label d-block">Vendedor</label>
                    <div class="btn-group btn-group-toggle" role="group">
                        <input type="radio" class="btn-check" name="vendedor" id="venSi" value="Si" checked>
                        <label class="btn btn-outline-primary" for="venSi">Sí</label>
                        <input type="radio" class="btn-check" name="vendedor" id="venNo" value="No">
                        <label class="btn btn-outline-secondary" for="venNo">No</label>
                    </div>
                </div>

                <div class="col-md-3">
                    <label class="form-label d-block">Arrendador</label>
                    <div class="btn-group btn-group-toggle" role="group">
                        <input type="radio" class="btn-check" name="arrendador" id="arrSi" value="Si">
                        <label class="btn btn-outline-primary" for="arrSi">Sí</label>
                        <input type="radio" class="btn-check" name="arrendador" id="arrNo" value="No" checked>
                        <label class="btn btn-outline-secondary" for="arrNo">No</label>
                    </div>
                </div>
            </div>

            <h5 class="section-header">Comentarios</h5>
            <div class="mb-4">
                <label class="form-label">Comentarios sobre el cliente</label>
                <textarea class="form-control" id="comentarios" rows="3"></textarea>
            </div>

            <div class="alert alert-info-custom p-3 mb-4">
                <h6 class="fw-bold mb-1">Atención</h6>
                <p class="mb-0">Haciendo click en el botón grabar, la propiedad cambiará de propietario siendo asignada
                    a este nuevo propietario indicado en el formulario.</p>
            </div>

            <div class="text-end">
                <button class="btn btn-primary px-4" onclick="guardarCambioPropietario()">
                    <i class="bi bi-check-lg"></i> Grabar
                </button>
            </div>

        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const propId = urlParams.get('propId');

        // ✅ CORRECCIÓN IMPORTANTE: Dejar vacío para que funcione siempre
        const API_URL = '';

        document.addEventListener('DOMContentLoaded', () => {
            if (propId) {
                cargarHeader(propId);
            } else {
                alert("Falta el ID de la propiedad.");
            }
        });

        async function cargarHeader(id) {
            try {
                const res = await fetch(`${API_URL}/api/propiedades2/${id}`);
                const json = await res.json();
                if (json.success) {
                    const p = json.data;
                    document.getElementById('header_cod').textContent = `Cód.: ${p.id} - ${p.tipo_propiedad} - ${p.comuna}`;
                }
            } catch (e) { }
        }

        async function guardarCambioPropietario() {
            const btn = document.querySelector('.btn-primary');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Guardando...';
            btn.disabled = true;

            const data = {
                rut: document.getElementById('rut').value,
                nombre: document.getElementById('nombre').value,
                apellidoP: document.getElementById('apellidoP').value,
                apellidoM: document.getElementById('apellidoM').value,
                email: document.getElementById('email').value,

                fono_fijo: document.getElementById('fono_fijo').value,
                celular: document.getElementById('celular').value,
                fono_comercial: document.getElementById('fono_comercial').value,

                es_activo: document.querySelector('input[name="activo"]:checked').value,
                es_vendedor: document.querySelector('input[name="vendedor"]:checked').value,
                es_arrendador: document.querySelector('input[name="arrendador"]:checked').value,

                comentarios: document.getElementById('comentarios').value
            };

            // --- VALIDACIONES ---

            // 1. Validar Campos Vacíos
            if (!data.rut || !data.nombre || !data.apellidoP || !data.email) {
                alert("⚠️ Por favor complete los campos obligatorios (*)");
                restaurarBoton();
                return;
            }

            // 2. Validar RUT Chileno
            const tipoDoc = document.querySelector('input[name="tipoDoc"]:checked').value;
            if (tipoDoc === 'RUT' && !validarRut(data.rut)) {
                alert("❌ El RUT ingresado NO es válido.\nRevise que el número y el dígito verificador coincidan (Ej: 12.345.678-K).");
                document.getElementById('rut').focus();
                restaurarBoton();
                return;
            }

            // 3. Validar Email
            if (!validarEmail(data.email)) {
                alert("❌ El formato del correo electrónico es incorrecto.");
                document.getElementById('email').focus();
                restaurarBoton();
                return;
            }

            // 4. Validar Celular (Opcional)
            if (data.celular && !validarTelefono(data.celular)) {
                alert("❌ El celular debe ser chileno válido (9 dígitos).\nEjemplos: 959801912 o +56959801912");
                document.getElementById('celular').focus();
                restaurarBoton();
                return;
            }

            // --- ENVÍO DE DATOS ---

            try {
                const res = await fetch(`${API_URL}/api/propiedades/${propId}/cambiar-propietario`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();

                if (json.success) {
                    alert("✅ " + json.message);
                    window.location.href = `admin-propiedad-propietario.html?id=${propId}`;
                } else {
                    alert("Error: " + json.error);
                }
            } catch (error) {
                console.error(error);
                alert("Error de conexión");
            } finally {
                restaurarBoton();
            }
        }

        /* ==========================================
           FUNCIONES AUXILIARES
           ========================================== */

        function validarRut(rut) {
            if (!rut || rut.trim().length < 3) return false;
            const valor = rut.replace(/\./g, '').replace(/-/g, '');
            const cuerpo = valor.slice(0, -1);
            const dv = valor.slice(-1).toUpperCase();

            if (!/^[0-9]+$/.test(cuerpo)) return false;

            let suma = 0;
            let multiplo = 2;

            for (let i = cuerpo.length - 1; i >= 0; i--) {
                suma += multiplo * cuerpo.charAt(i);
                multiplo = (multiplo < 7) ? multiplo + 1 : 2;
            }

            const dvEsperado = 11 - (suma % 11);
            const dvCalculado = (dvEsperado === 11) ? '0' : (dvEsperado === 10) ? 'K' : dvEsperado.toString();

            return dv === dvCalculado;
        }

        function validarEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function validarTelefono(fono) {
            const limpio = fono.replace(/\s/g, '').replace(/\+/g, '');
            // Acepta formato 9XXXXXXXX (9 dígitos) o 569XXXXXXXX (11 dígitos)
            const re = /^(56)?9\d{8}$/;
            return re.test(limpio);
        }

        function restaurarBoton() {
            const btn = document.querySelector('.btn-primary');
            btn.innerHTML = '<i class="bi bi-check-lg"></i> Grabar';
            btn.disabled = false;
        }
    </script>
    <script src="admin-auth.js"></script>
</body>

</html>