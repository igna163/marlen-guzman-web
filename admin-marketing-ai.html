<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing AI - Panel Admin</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-sidebar.css">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Open Sans', sans-serif;
            color: #555;
        }





        /* Tarjetas de Redes Sociales */
        .social-card {
            border: 2px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 10px;
        }

        .social-card:hover {
            transform: translateY(-3px);
            border-color: #ccc;
        }

        .social-card.active {
            border-color: #0d6efd;
            background-color: #e7f1ff;
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.2);
        }

        .instagram {
            color: #E1306C;
        }

        .facebook {
            color: #4267B2;
        }

        .linkedin {
            color: #0077b5;
        }

        .whatsapp {
            color: #25D366;
        }

        /* Preview del Post (Simulador Celular) */
        .phone-mockup {
            background: white;
            border: 12px solid #2c3e50;
            border-radius: 30px;
            padding: 15px;
            max-width: 340px;
            margin: 0 auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            min-height: 580px;
            position: relative;
        }

        /* Notch del celular */
        .phone-mockup::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 20px;
            background: #2c3e50;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            margin-top: 15px;
        }

        .fb-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: #0d6efd;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .fb-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: #1c1e21;
        }

        .fb-time {
            font-size: 0.75rem;
            color: #65676b;
        }

        .fb-text {
            font-size: 0.9rem;
            color: #050505;
            line-height: 1.4;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }

        .fb-image-container {
            background: #f0f2f5;
            width: 100%;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .fb-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .fb-actions {
            border-top: 1px solid #ced0d4;
            padding-top: 8px;
            margin-top: 8px;
            display: flex;
            justify-content: space-around;
            color: #65676b;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Animaci√≥n "Pensando" */
        @keyframes pulse-purple {
            0% {
                box-shadow: 0 0 0 0 rgba(111, 66, 193, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(111, 66, 193, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(111, 66, 193, 0);
            }
        }

        .btn-ai-generate {
            background: linear-gradient(45deg, #6f42c1, #0d6efd);
            border: none;
            color: white;
            animation: pulse-purple 2s infinite;
        }

        .btn-ai-generate:hover {
            opacity: 0.9;
            color: white;
        }
    </style>
</head>

<body>

    <div class="sidebar"></div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-dark"><i class="bi bi-robot text-primary"></i> Generador de Campa√±as IA</h3>
                <p class="text-muted mb-0">Crea anuncios virales gratis usando algoritmos inteligentes.</p>
            </div>
            <div class="text-end">
                <span class="badge bg-success p-2">Modo: Gratuito (Simulado)</span>
                <span class="badge bg-secondary p-2">Meta Ads: Desconectado</span>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7">
                <div class="card border-0 shadow-sm p-4 mb-4">

                    <h5 class="mb-3 text-secondary">1. Configura tu Anuncio</h5>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Propiedad a promocionar</label>
                        <select class="form-select form-select-lg" id="selectPropiedad"
                            onchange="cargarDetallePropiedad()">
                            <option value="">-- Cargando propiedades... --</option>
                        </select>
                        <small class="text-primary fw-bold" id="fotoCounter"></small>
                    </div>

                    <h5 class="mb-3 text-secondary">2. Elige la Plataforma</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-3">
                            <div class="card p-2 text-center social-card active"
                                onclick="selectPlatform(this, 'instagram')">
                                <i class="bi bi-instagram fs-3 instagram"></i>
                                <div class="small fw-bold mt-1">Instagram</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card p-2 text-center social-card" onclick="selectPlatform(this, 'facebook')">
                                <i class="bi bi-facebook fs-3 facebook"></i>
                                <div class="small fw-bold mt-1">Facebook</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card p-2 text-center social-card" onclick="selectPlatform(this, 'linkedin')">
                                <i class="bi bi-linkedin fs-3 linkedin"></i>
                                <div class="small fw-bold mt-1">LinkedIn</div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card p-2 text-center social-card" onclick="selectPlatform(this, 'whatsapp')">
                                <i class="bi bi-whatsapp fs-3 whatsapp"></i>
                                <div class="small fw-bold mt-1">WhatsApp</div>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-3 text-secondary">3. Estrategia de IA</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Tono de Comunicaci√≥n</label>
                            <select class="form-select" id="tonoIA">
                                <option value="aspiracional">ü§© Aspiracional (Emocional)</option>
                                <option value="urgencia">üî• Urgencia (Oportunidad)</option>
                                <option value="corporativo">üëî Corporativo (Inversionista)</option>
                                <option value="cercano">ü§ù Cercano (Amigable)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Objetivo</label>
                            <select class="form-select" id="objetivoIA">
                                <option value="visita">Conseguir Visitas</option>
                                <option value="info">Recibir Mensajes (DM)</option>
                                <option value="trafico">Clics al Sitio Web</option>
                            </select>
                        </div>
                    </div>

                    <button class="btn btn-ai-generate w-100 py-3 fw-bold shadow rounded-pill"
                        onclick="generarAnuncio()">
                        <i class="bi bi-stars"></i> GENERAR COPY CON INTELIGENCIA ARTIFICIAL
                    </button>
                </div>
            </div>

            <div class="col-lg-5">
                <h6 class="text-center text-muted mb-3">Vista Previa en Tiempo Real</h6>

                <div class="phone-mockup">
                    <div class="post-header">
                        <div class="fb-avatar d-flex align-items-center justify-content-center text-white">
                            <i class="bi bi-building"></i>
                        </div>
                        <div>
                            <div class="fb-name">Marlen Guzm√°n Propiedades</div>
                            <div class="fb-time">Publicidad ‚Ä¢ <i class="bi bi-globe"></i></div>
                        </div>
                    </div>

                    <div class="fb-text" id="postText">
                        üëã Hola Marlen, selecciona una propiedad a la izquierda y presiona "Generar" para ver la magia
                        de la IA aqu√≠.
                    </div>

                    <div class="fb-image-container">
                        <img id="postImage" src="https://placehold.co/400x300?text=Selecciona+Propiedad"
                            class="fb-image">
                        <div class="gallery-badge" id="galleryBadge"
                            style="display:none; position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: bold;">
                            +0</div>
                    </div>
                    <div class="bg-light p-2 mb-2 d-flex justify-content-between align-items-center border rounded">
                        <div>
                            <small class="text-muted d-block" style="font-size: 0.65rem;">INMOBILIARIANEXXOS.CL</small>
                            <span class="fw-bold small">Ver Propiedad Exclusiva</span>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm px-3">M√°s informaci√≥n</button>
                    </div>

                    <div class="fb-actions">
                        <span><i class="bi bi-hand-thumbs-up"></i> Me gusta</span>
                        <span><i class="bi bi-chat-square"></i> Comentar</span>
                        <span><i class="bi bi-share"></i> Compartir</span>
                    </div>

                    <div class="mt-4 d-grid gap-2">
                        <button class="btn btn-outline-dark btn-sm rounded-pill" onclick="copiarTexto()">
                            <i class="bi bi-clipboard"></i> Copiar Texto
                        </button>

                        <button id="btnPublicar" class="btn btn-primary btn-sm rounded-pill fw-bold shadow-sm"
                            onclick="publicarReal()">
                            <i class="bi bi-facebook"></i> PUBLICAR EN FACEBOOK
                        </button>
                    </div>
                </div>

                <div class="card mt-4 border-0 shadow-sm">
                    <div class="card-body">
                        <h6 class="fw-bold text-success"><i class="bi bi-graph-up"></i> Predicci√≥n de Rendimiento</h6>
                        <div class="d-flex justify-content-between mt-3 text-center">
                            <div>
                                <h4 class="mb-0 fw-bold">12k</h4>
                                <small class="text-muted">Alcance</small>
                            </div>
                            <div>
                                <h4 class="mb-0 fw-bold">1.5%</h4>
                                <small class="text-muted">CTR Est.</small>
                            </div>
                            <div>
                                <h4 class="mb-0 fw-bold">15-20</h4>
                                <small class="text-muted">Leads</small>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let currentPlatform = 'instagram';
        let propiedadesLista = [];
        let propiedadSeleccionadaFull = null; // Aqu√≠ guardaremos TODA la info (incluidas las 37 fotos)

        // ‚úÖ TUS T√öNELES CLOUDFLARE ACTUALES
        const SERVER_TUNNEL_URL = 'https://marlen-guzman-web.onrender.com';
        const N8N_TUNNEL_URL = 'https://n8n-marlen-auto.onrender.com';

        document.addEventListener('DOMContentLoaded', () => {
            cargarPropiedadesSelect();
        });

        // 1. CARGAR LA LISTA PARA EL SELECT
        async function cargarPropiedadesSelect() {
            const select = document.getElementById('selectPropiedad');
            try {
                const res = await fetch('/api/propiedades-list?limit=100');
                const json = await res.json();
                if (json.success) {
                    propiedadesLista = json.data;
                    select.innerHTML = '<option value="">-- Selecciona una propiedad --</option>';
                    propiedadesLista.forEach(p => {
                        const op = p.operacion_venta ? 'Venta' : 'Arriendo';
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = `#${p.id} | ${p.tipo_propiedad} en ${p.comuna} (${op})`;
                        select.appendChild(opt);
                    });
                }
            } catch (error) { console.error(error); }
        }

        // 2. CARGAR DETALLE COMPLETO (LAS 37 FOTOS)
        // Se ejecuta cuando cambias el select
        async function cargarDetallePropiedad() {
            const id = document.getElementById('selectPropiedad').value;
            if (!id) return;

            const counter = document.getElementById('fotoCounter'); // Aseg√∫rate de tener un <small id="fotoCounter"> en tu HTML si quieres ver el texto
            if (counter) counter.innerText = "Consultando galer√≠a...";

            try {
                // LLAMAMOS A LA API QUE TRAE LA GALER√çA COMPLETA
                const res = await fetch(`/api/propiedades2/${id}`);
                const json = await res.json();

                if (json.success) {
                    propiedadSeleccionadaFull = json; // Guardamos todo en memoria

                    const imgs = json.imagenes || [];
                    const totalFotos = imgs.length;

                    if (counter) counter.innerText = `üì∏ Fotos detectadas: ${totalFotos}`;

                    // Mostrar la primera foto en la preview
                    const imgPreview = document.getElementById('postImage');
                    const badge = document.getElementById('galleryBadge');

                    if (totalFotos > 0) {
                        // Construimos la URL p√∫blica para la primera foto (Portada)
                        const primeraUrl = SERVER_TUNNEL_URL + imgs[0].url_imagen;
                        imgPreview.src = primeraUrl;

                        if (totalFotos > 1) {
                            badge.style.display = 'block';
                            // Mostramos cu√°ntas m√°s se subir√°n (Max 10 en total, as√≠ que +9)
                            const extras = Math.min(totalFotos - 1, 9);
                            badge.innerText = `+${extras} fotos`;
                        } else {
                            badge.style.display = 'none';
                        }
                    } else {
                        imgPreview.src = "https://via.placeholder.com/400x300?text=Sin+Fotos";
                        badge.style.display = 'none';
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        // 3. SELECCIONAR PLATAFORMA
        function selectPlatform(card, platform) {
            document.querySelectorAll('.social-card').forEach(c => c.classList.remove('active'));
            card.classList.add('active');
            currentPlatform = platform;
        }

        // 4. GENERAR COPY IA
        function generarAnuncio() {
            if (!propiedadSeleccionadaFull) { alert("Selecciona propiedad primero"); return; }
            const p = propiedadSeleccionadaFull.data;
            const tono = document.getElementById('tonoIA').value;
            const btn = document.querySelector('.btn-ai-generate');
            const textArea = document.getElementById('postText');

            btn.innerHTML = '‚ú® Creando magia...';

            setTimeout(() => {
                const precio = p.operacion_venta
                    ? (p.moneda_venta + ' ' + new Intl.NumberFormat('es-CL').format(p.precio_venta))
                    : (p.moneda_arriendo + ' ' + new Intl.NumberFormat('es-CL').format(p.precio_arriendo));

                let texto = "";
                if (tono === 'urgencia') texto = `üö® ¬°OPORTUNIDAD √öNICA EN ${p.comuna.toUpperCase()}! üî•\n\nüè° ${p.tipo_propiedad} disponible.\nüí∞ ${precio}\nüìç Sector exclusivo.\n\n¬°Escr√≠benos YA antes de que se vaya! üì≤\n#${p.comuna.replace(/\s/g, '')} #Venta`;
                else texto = `‚ú® Tu nuevo hogar te espera en ${p.comuna} üåø\n\nDescubre este hermoso ${p.tipo_propiedad} dise√±ado para ti.\nüíé Valor: ${precio}\nüìç ${p.direccion_calle || 'Ubicaci√≥n privilegiada'}\n\nAgenda tu visita hoy mismo. üóùÔ∏è\n#Propiedades #Chile #${p.comuna.replace(/\s/g, '')}`;

                textArea.innerText = texto;
                btn.innerHTML = '<i class="bi bi-stars"></i> GENERAR NUEVO COPY';
            }, 1000);
        }

        function copiarTexto() {
            const t = document.getElementById('postText').innerText;
            navigator.clipboard.writeText(t).then(() => alert("Texto copiado"));
        }

        // 5. PUBLICAR REALMENTE (ENVIAR ARRAY DE FOTOS A N8N)
        async function publicarReal() {
            if (!propiedadSeleccionadaFull || !propiedadSeleccionadaFull.imagenes) {
                alert("No se han cargado los datos de la propiedad a√∫n.");
                return;
            }

            const btn = document.getElementById('btnPublicar');
            const texto = document.getElementById('postText').innerText;

            // A. PREPARAR LAS IM√ÅGENES
            const todasLasFotos = propiedadSeleccionadaFull.imagenes; // Array de la base de datos

            if (todasLasFotos.length === 0) {
                alert("Esta propiedad no tiene fotos.");
                return;
            }

            // B. PROCESAR: Tomar las primeras 10 y convertirlas a URLs p√∫blicas
            const urlsPublicas = todasLasFotos.slice(0, 10).map(img => SERVER_TUNNEL_URL + img.url_imagen);

            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Publicando en vivo...';
            btn.disabled = true;

            // C. CREAR PAQUETE PARA N8N
            const payload = {
                mensaje: texto,
                imagen: urlsPublicas[0],
                imagenes: urlsPublicas,
                plataforma: currentPlatform
            };

            console.log("üöÄ Enviando a N8N:", payload);

            // D. DETECTAR PLATAFORMA Y ASIGNAR LA URL CORRECTA DEL WEBHOOK
            let webhookUrl = "";
            if (currentPlatform === 'instagram') {
                webhookUrl = `${N8N_TUNNEL_URL}/webhook/publicar-propiedad-instagram-2402`;
            } else if (currentPlatform === 'facebook') {
                webhookUrl = `${N8N_TUNNEL_URL}/webhook/publicar-propiedad-facebook-2402`;
            } else {
                alert("‚ùå Plataforma no soportada para publicaci√≥n autom√°tica todav√≠a.");
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }

            try {
                // Apuntando din√°micamente a la URL seg√∫n la red social seleccionada
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // E. PROCESAR RESPUESTA DEL NODO "RESPOND TO WEBHOOK" DE N8N
                if (response.ok) {
                    // Leemos el JSON que nos manda n8n de vuelta
                    const result = await response.json();

                    if (result.success) {
                        alert(`‚úÖ ${result.message}\nID de publicaci√≥n: ${result.post_id}`);
                        btn.className = "btn btn-success btn-sm rounded-pill fw-bold shadow-sm";
                        btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> PUBLICADO EXITOSAMENTE';
                    } else {
                        throw new Error(result.message || "Error desconocido en el flujo de N8N");
                    }
                } else {
                    throw new Error(`Error en el servidor: ${response.status}`);
                }
            } catch (error) {
                console.error(error);
                alert("‚ùå Error de conexi√≥n o ejecuci√≥n en N8N. Verifica que el flujo est√© activo (Publish).");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="admin-auth.js"></script>
    <script src="js/admin-sidebar.js"></script>
</body>

</html>