<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informes Propietario - Nexxos Admin</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-sidebar.css">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Open Sans', sans-serif;
            color: #555;
            overflow-x: hidden;
        }

        /* SIDEBAR y GENERALES (Se mantienen igual) */
        /* SIDEBAR y GENERALES (Se mantienen igual) */
        /* Eliminados estilos inline de sidebar para usar admin-sidebar.css */

        /* WIZARD (Se mantiene igual) */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 50px;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            background-color: #ddd;
            color: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
        }

        .step.active .step-circle {
            background-color: #5b9bd5;
        }

        .step-line {
            position: absolute;
            top: 20px;
            left: 100px;
            right: 100px;
            height: 3px;
            background-color: #ddd;
            z-index: -1;
        }

        /* --- ESTILOS DEL REPORTE TIPO NEXXOS (NUEVO) --- */
        #preview-informe {
            background: white;
            width: 100%;
            max-width: 800px;
            min-height: 1000px;
            /* Tamaño carta aprox */
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            font-family: 'Open Sans', sans-serif;
        }

        /* Cabecera */
        .rep-header {
            padding: 40px 40px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rep-logo {
            height: 50px;
        }

        .rep-url {
            font-size: 0.8rem;
            color: #666;
        }

        /* Hero / Portada */
        .rep-hero {
            display: flex;
            margin-top: 20px;
            height: 350px;
            position: relative;
        }

        .rep-hero-left {
            width: 40%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .rep-title-box h1 {
            font-weight: 300;
            font-size: 2.5rem;
            color: #444;
            line-height: 1.2;
            margin: 0;
        }

        .rep-title-box h2 {
            font-weight: 700;
            font-size: 2.5rem;
            color: #333;
            margin: 0;
            margin-bottom: 10px;
        }

        .rep-year {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
        }

        .rep-hero-right {
            width: 60%;
            position: relative;
            background-size: cover;
            background-position: center;
            border-top-left-radius: 100px;
            /* Efecto curva */
            border-bottom-left-radius: 0;
            overflow: hidden;
            margin-right: -20px;
            /* Desborde para diseño */
        }

        /* Detalles Propiedad */
        .rep-prop-details {
            padding: 30px 40px;
        }

        .rep-prop-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .rep-prop-loc {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .rep-specs {
            display: flex;
            gap: 20px;
            color: #444;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .rep-price {
            font-size: 1.2rem;
            color: #2a81ae;
            font-weight: 700;
            margin-top: 10px;
        }

        /* Secciones Internas */
        .rep-section {
            padding: 20px 40px;
        }

        .rep-sec-title {
            background-color: #5c9cd6;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: inline-block;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tablas y Badges */
        .rep-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .rep-table th {
            background: #3c4b64;
            color: white;
            padding: 8px;
            text-align: left;
        }

        .rep-table td {
            border-bottom: 1px solid #eee;
            padding: 8px;
            color: #555;
        }

        .kpi-circle {
            width: 80px;
            height: 80px;
            background: #3c4b64;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin: 0 auto;
        }

        /* Footer Agente */
        .rep-footer {
            margin-top: 40px;
            padding: 30px 40px;
            background: #f8f9fa;
            border-top: 4px solid #5c9cd6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
        }

        .agent-contact {
            font-size: 0.9rem;
            color: #666;
        }

        /* --- ESTILOS NUEVOS PARA EL REPORTE PRO (Pegar al final del CSS) --- */
        #preview-informe {
            background: white;
            width: 100%;
            max-width: 800px;
            min-height: 1100px;
            /* Alto hoja carta */
            margin: 0 auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
            font-family: 'Open Sans', sans-serif;
        }

        /* Cabecera y Logo */
        .rep-header {
            padding: 40px 40px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rep-logo {
            height: 45px;
        }

        /* PORTADA CON CURVA */
        .rep-hero {
            display: flex;
            height: 380px;
            margin-top: 10px;
            position: relative;
        }

        .rep-hero-left {
            width: 45%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .rep-hero-left h1 {
            font-weight: 300;
            font-size: 2.2rem;
            color: #444;
            margin: 0;
            line-height: 1;
        }

        .rep-hero-left h2 {
            font-weight: 800;
            font-size: 2.5rem;
            color: #333;
            margin: 0;
            margin-bottom: 10px;
            line-height: 1;
            text-transform: uppercase;
        }

        .rep-hero-left .year {
            font-size: 2rem;
            font-weight: 800;
            color: #333;
            margin-top: 10px;
        }

        .rep-hero-right {
            width: 55%;
            background-size: cover;
            background-position: center;
            border-top-left-radius: 120px;
            /* LA CURVA MÁGICA */
            overflow: hidden;
            position: relative;
            margin-right: -20px;
        }

        /* DATOS DE PROPIEDAD */
        .rep-details {
            padding: 30px 40px;
        }

        .rep-cod {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            display: inline-block;
            margin-bottom: 5px;
        }

        .rep-type {
            font-size: 1.6rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0;
            line-height: 1.2;
        }

        .rep-loc {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .rep-specs {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
        }

        .rep-price {
            font-size: 1.3rem;
            color: #2980b9;
            font-weight: 700;
            margin-top: 10px;
        }

        /* SECCIONES INTERNAS */
        .rep-section {
            padding: 20px 40px;
        }

        .rep-sec-header {
            background-color: #5b9bd5;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .rep-sec-icon {
            background: white;
            color: #5b9bd5;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rep-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .rep-table th {
            background: #34495e;
            color: white;
            padding: 8px;
            text-align: left;
        }

        .rep-table td {
            border-bottom: 1px solid #eee;
            padding: 8px;
            color: #555;
        }

        /* FOOTER */
        .rep-footer {
            background: #f8f9fa;
            border-top: 5px solid #5b9bd5;
            padding: 30px 40px;
            margin-top: 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar">
            <div class="sidebar-brand">
                <img src="Logo_MG.jpeg" alt="Logo MG">
                <div>ADMIN</div>
            </div>
            <div class="text-center p-3 border-bottom border-secondary pt-4">
                <h6 class="text-white fw-bold mb-0" id="sidebar_cod">Cargando...</h6>
                <div class="text-muted small mt-1" id="sidebar_comuna">...</div>
            </div>

            <div class="py-2">
                <a href="#" class="d-flex align-items-center"><i class="bi bi-house me-2"></i> Resumen</a>
                <a href="#" id="link_editar" class="d-flex align-items-center"><i class="bi bi-pencil-square me-2"></i>
                    Editar</a>
                <a href="#" id="link_imagenes" class="d-flex align-items-center"><i class="bi bi-images me-2"></i>
                    Imágenes</a>
                <a href="#" id="link_documentos" class="d-flex align-items-center"><i class="bi bi-folder me-2"></i>
                    Documentos</a>
                <a href="#" id="link_estado" class="d-flex align-items-center"><i class="bi bi-gear me-2"></i>
                    Estado</a>
                <a href="#" id="link_bitacora" class="d-flex align-items-center"><i
                        class="bi bi-chat-left-text me-2"></i>
                    Bitácora</a>
                <a href="#" id="link_propietario" class="d-flex align-items-center"><i class="bi bi-person me-2"></i>
                    Propietario</a>
                <a href="#" class="active d-flex align-items-center"><i class="bi bi-list-ul me-2"></i> Informes
                    prop.</a>

                <hr class="border-secondary mx-3">
                <a href="admin-propiedades.html" class="text-muted small"><i class="bi bi-arrow-left me-2"></i> Volver
                    al
                    listado</a>
            </div>
        </div>

        <div class="main-content">
            <h4 class="mb-4 text-secondary"><i class="bi bi-house-door-fill"></i> INFORMES PARA EL PROPIETARIO</h4>

            <div id="vista-listado">
                <div class="card border-0 shadow-sm p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <h5 class="text-primary m-0">Informes realizados</h5>
                        <button class="btn btn-nexxos btn-sm rounded-pill px-3" onclick="mostrarWizard()">
                            <i class="bi bi-plus-circle"></i> Generar nuevo informe
                        </button>
                    </div>
                    <div id="lista-informes">
                        <div class="text-center py-5">
                            <div class="spinner-border text-secondary"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vista-wizard" style="display: none;">
                <h5 class="text-secondary mb-4">Generar informe</h5>

                <div class="step-indicator">
                    <div class="step-line">
                        <div class="step-line-fill" id="progress-bar"></div>
                    </div>
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Configuración</div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Ó. Visita</div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Confirmación</div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Finalizar</div>
                    </div>
                </div>

                <div id="contenido-paso-1" class="form-section fade-in">

                    <div class="config-row">
                        <div class="config-label">Título</div>
                        <div class="config-input">
                            <input type="text" class="form-control" id="informe_titulo">
                            <div class="info-text">Título que tendrá el informe. Ej.: "Informe Abril 2020"</div>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-label">Mostrar órdenes de visita</div>
                        <div class="config-input">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_ov" id="ov_si" value="si"
                                    checked>
                                <label class="form-check-label" for="ov_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_ov" id="ov_no" value="no">
                                <label class="form-check-label" for="ov_no">No</label>
                            </div>
                            <div class="info-text">Si queremos que se muestren las Órdenes de Visita realizadas en el
                                informe.</div>

                            <div class="mt-3">
                                <label class="fw-bold small">Título órdenes de visita</label>
                                <input type="text" class="form-control form-control-sm" id="ov_titulo"
                                    value="Órdenes de Visita">
                                <div class="info-text">Título que encabezará las Órdenes de Visita en el informe.</div>
                            </div>
                            <div class="mt-3">
                                <label class="fw-bold small">Subtítulo O.Visita</label>
                                <input type="text" class="form-control form-control-sm" id="ov_subtitulo"
                                    value="Listado de Órdenes de Visita emitidas por su propiedad">
                                <div class="info-text">Subtítulo de las Órdenes de Visita en el informe.</div>
                            </div>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-label">Mostrar portales</div>
                        <div class="config-input">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_portales" id="p_si" value="si"
                                    checked>
                                <label class="form-check-label" for="p_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_portales" id="p_no" value="no">
                                <label class="form-check-label" for="p_no">No</label>
                            </div>
                            <div class="info-text">Si queremos que se muestren los portales en que está publicada la
                                propiedad.</div>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-label">Mostrar contactos recibidos</div>
                        <div class="config-input">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_contactos" id="c_si" value="si"
                                    checked>
                                <label class="form-check-label" for="c_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_contactos" id="c_no" value="no">
                                <label class="form-check-label" for="c_no">No</label>
                            </div>
                            <div class="info-text">Contactos que se contabilizan automáticamente en el sistema (Sitio
                                web,
                                Portal Inmobiliario).</div>

                            <div class="mt-3">
                                <label class="fw-bold small">Título contactos recibidos</label>
                                <input type="text" class="form-control form-control-sm" id="c_titulo"
                                    value="Contactos recibidos">
                                <div class="info-text">Título que encabezará la sección de contactos recibidos y
                                    contabilizados en forma automática.</div>
                            </div>
                            <div class="mt-3">
                                <label class="fw-bold small">Leyenda contactos recibidos</label>
                                <input type="text" class="form-control form-control-sm" id="c_leyenda"
                                    value="Contactos recibidos a través de nuestro sitio web y Portal Inmobiliario / Mercado Libre.">
                                <div class="info-text">Leyenda que describirá la sección de contactos recibidos en forma
                                    automática.</div>
                            </div>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-label">Mostrar otros contactos</div>
                        <div class="config-input">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_otros" id="o_si" value="si"
                                    checked>
                                <label class="form-check-label" for="o_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_otros" id="o_no" value="no">
                                <label class="form-check-label" for="o_no">No</label>
                            </div>
                            <div class="info-text">Contactos recibidos por portales que NO se contabilizan
                                automáticamente.
                            </div>

                            <div class="mt-3">
                                <label class="fw-bold small">Título otros contactos</label>
                                <input type="text" class="form-control form-control-sm" id="o_titulo"
                                    value="Otros contactos">
                                <div class="info-text">Título que encabezará la sección de otros contactos que NO son
                                    contabilizados en forma automática.</div>
                            </div>
                            <div class="mt-3">
                                <label class="fw-bold small">Leyenda otros contactos</label>
                                <input type="text" class="form-control form-control-sm" id="o_leyenda"
                                    value="Contactos recibidos por portales que no son Portal Inmobiliario, o por otras vías que no permiten su contabilización">
                                <div class="info-text">Leyenda que describirá la sección de otros contactos que NO son
                                    contabilizados en forma automática.</div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <label class="fw-bold small">Otros contactos: Últimos 30 días</label>
                                    <input type="number" class="form-control form-control-sm" id="otros_30" value="0">
                                    <div class="info-text">Nº de contactos recibidos en los últimos 30 días por portales
                                        que
                                        no se contabilizan en forma automática.</div>
                                </div>
                                <div class="col-6">
                                    <label class="fw-bold small">Otros contactos: Totales</label>
                                    <input type="number" class="form-control form-control-sm" id="otros_total"
                                        value="0">
                                    <div class="info-text">Nº de contactos totales recibidos por portales que no se
                                        contabilizan en forma automática.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-label">Mostrar visitas a ficha</div>
                        <div class="config-input">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_visitas_ficha" id="vf_si"
                                    value="si" checked>
                                <label class="form-check-label" for="vf_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_visitas_ficha" id="vf_no"
                                    value="no">
                                <label class="form-check-label" for="vf_no">No</label>
                            </div>
                            <div class="info-text">Si queremos que se muestren las visitas recibidas por la ficha de la
                                propiedad.</div>
                            <div class="mt-3">
                                <label class="fw-bold small">Título visitas a ficha</label>
                                <input type="text" class="form-control form-control-sm" id="vf_titulo"
                                    value="Visitas ficha propiedad">
                                <div class="info-text">Título que encabezará la sección de visitas a la ficha
                                    contabilizados
                                    en forma automática.</div>
                            </div>
                            <div class="mt-3">
                                <label class="fw-bold small">Leyenda visitas a ficha</label>
                                <input type="text" class="form-control form-control-sm" id="vf_leyenda"
                                    value="Visitas recibidas por la ficha de su propiedad a través de nuestro sitio web y de Portal Inmobiliario / Mercado Libre.">
                                <div class="info-text">Leyenda que describirá la sección de visitas a la ficha de
                                    propiedad
                                    en forma automática.</div>
                            </div>
                        </div>
                    </div>

                    <div class="config-row">
                        <div class="config-label">Mostrar Nº de veces que se ha ofrecido</div>
                        <div class="config-input">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_ofrecida" id="of_si" value="si"
                                    checked>
                                <label class="form-check-label" for="of_si">Sí</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="opt_ofrecida" id="of_no" value="no">
                                <label class="form-check-label" for="of_no">No</label>
                            </div>
                            <div class="info-text">Número de veces que la propiedad ha sido enviada a interesados vía
                                correo
                                electrónico.</div>
                            <div class="mt-3">
                                <label class="fw-bold small">Título ofrecida a...</label>
                                <input type="text" class="form-control form-control-sm" id="of_titulo"
                                    value="Ofrecida a">
                                <div class="info-text">Título que encabezará la sección de nº de veces que se ha
                                    ofrecido la
                                    propiedad.</div>
                            </div>
                            <div class="mt-3">
                                <label class="fw-bold small">Leyenda ofrecida a...</label>
                                <input type="text" class="form-control form-control-sm" id="of_leyenda"
                                    value="Número de veces que la propiedad ha sido enviada a interesados vía correo electrónico.">
                                <div class="info-text">Leyenda que describirá la sección de nº de veces que se ha
                                    ofrecido
                                    la propiedad.</div>
                            </div>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <button class="btn btn-secondary me-2" onclick="cancelarWizard()">Cancelar</button>
                        <button class="btn btn-primary px-4" onclick="irPaso2()">Continuar <i
                                class="bi bi-arrow-right"></i></button>
                    </div>
                </div>

                <div id="contenido-paso-2" class="form-section fade-in" style="display: none;">
                    <div class="alert alert-light border-start border-4 border-info shadow-sm">
                        <i class="bi bi-info-circle-fill text-info me-2"></i> Seleccione las Órdenes de Visita que desea
                        incluir en el informe.
                    </div>

                    <div id="lista-ordenes-visita">
                        <div class="text-center py-5">
                            <div class="spinner-border text-secondary"></div>
                            <p class="mt-2 text-muted small">Buscando visitas agendadas...</p>
                        </div>
                    </div>

                    <div class="text-end mt-4 pt-3 border-top">
                        <button class="btn btn-secondary me-2" onclick="volverPaso1()">Atrás</button>
                        <button class="btn btn-primary px-4" onclick="irPaso3()">Continuar <i
                                class="bi bi-arrow-right ms-1"></i></button>
                    </div>
                </div>

                <div id="contenido-paso-3" class="form-section fade-in" style="display: none;">
                    <h5 class="text-secondary mb-3"><i class="bi bi-eye"></i> Previsualización del Informe</h5>

                    <div id="preview-informe" class="border shadow-sm p-5 mx-auto bg-white"
                        style="max-width: 800px; min-height: 600px;">
                        <div class="d-flex justify-content-between border-bottom pb-3 mb-4">
                            <div>
                                <h2 class="fw-bold text-dark" id="prev-titulo">Título del Informe</h2>
                                <p class="text-muted small mb-0">Inmobiliaria Marlen Guzmán</p>
                            </div>
                            <div class="text-end">
                                <img src="Logo_MG.jpeg" height="50" alt="Logo">
                                <div class="small text-muted mt-2" id="prev-fecha">Fecha: ...</div>
                            </div>
                        </div>

                        <div id="prev-seccion-visitas" class="mb-4">
                            <h5 class="text-primary border-bottom pb-1 mb-2">Órdenes de Visita Realizadas</h5>
                            <table class="table table-sm table-striped" style="font-size: 0.85rem;">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Comentarios</th>
                                    </tr>
                                </thead>
                                <tbody id="prev-tabla-visitas">
                                </tbody>
                            </table>
                        </div>

                        <div id="prev-seccion-portales" class="mb-4">
                            <h5 class="text-primary border-bottom pb-1 mb-2">Publicación en Portales</h5>
                            <div class="row text-center g-3" id="prev-grid-portales">
                            </div>
                        </div>

                        <div class="mt-5 pt-4 border-top text-center text-muted small">
                            <p>Informe generado automáticamente por sistema de gestión.</p>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button class="btn btn-secondary me-2" onclick="volverPaso2()">Atrás (Editar)</button>
                        <button class="btn btn-success px-5" onclick="guardarInforme()">
                            <i class="bi bi-file-earmark-pdf"></i> Confirmar y Generar PDF
                        </button>
                    </div>
                </div>

                <div id="contenido-paso-4" class="form-section fade-in" style="display: none;">
                    <div class="text-center py-4">
                        <div class="mb-3"><i class="bi bi-envelope-check-fill text-primary"
                                style="font-size: 3rem;"></i>
                        </div>
                        <h4>¡Informe Generado!</h4>
                        <p class="text-muted">El informe ha sido creado y guardado en el historial.</p>
                        <button class="btn btn-primary mt-3 px-4" onclick="cancelarWizard()">Volver al listado</button>
                    </div>
                </div>

            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const propId = urlParams.get('id');
            const API_URL = ''; // Usar ruta relativa

            let propiedadData = null; // Variable global para datos de la casa

            // INICIO
            document.addEventListener('DOMContentLoaded', async () => {
                if (propId) {
                    configurarLinks(propId);
                    await cargarDatosPropiedad(); // Esperamos datos
                    cargarInformes(); // Cargamos historial
                    cargarOrdenesVisita(); // Cargamos visitas para el paso 2

                    // Configurar título automático
                    const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                    const f = new Date();
                    // Mes siguiente para simular gestión
                    let mesIndex = f.getMonth() + 1;
                    if (mesIndex > 11) mesIndex = 0;
                    const anio = mesIndex === 0 ? f.getFullYear() + 1 : f.getFullYear();

                    document.getElementById('informe_titulo').value = `Informe Gestión ${meses[mesIndex]} ${anio}`;
                } else {
                    alert("Falta ID de propiedad en la URL");
                }
            });

            // 1. CARGAR DATOS PROPIEDAD
            async function cargarDatosPropiedad() {
                try {
                    console.log("Cargando propiedad ID:", propId);
                    const res = await fetch(`${API_URL}/api/propiedades2/${propId}`);
                    const json = await res.json();

                    if (json.success) {
                        propiedadData = json.data;
                        console.log("Datos cargados:", propiedadData);
                        // Actualizar sidebar
                        if (document.getElementById('sidebar_comuna'))
                            document.getElementById('sidebar_comuna').innerText = propiedadData.titulo_publicacion || 'Sin Título';
                    } else {
                        console.error("Error API:", json.message);
                    }
                } catch (e) {
                    console.error("Error fetch propiedad:", e);
                }
            }

            // 2. CARGAR VISITAS (PASO 2)
            async function cargarOrdenesVisita() {
                const contenedor = document.getElementById('lista-ordenes-visita');
                try {
                    // En producción usarías: /api/citas?propiedad_id=${propId}
                    const res = await fetch(`${API_URL}/api/citas`);
                    const citas = await res.json();

                    if (citas && citas.length > 0) {
                        let html = `
                    <div class="table-responsive">
                        <table class="table table-hover align-middle border bg-white">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 40px;"><input type="checkbox" class="form-check-input" id="check_all_ov" checked onclick="toggleAllOV(this)"></th>
                                    <th>Fecha</th><th>Cliente</th><th>Comentario</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        // Mostramos solo las ultimas 5 para ejemplo
                        citas.slice(0, 10).forEach(cita => {
                            const fechaFmt = new Date(cita.fecha).toLocaleDateString();
                            html += `
                            <tr>
                                <td><input type="checkbox" class="form-check-input ov-check" value="${cita.id}" checked></td>
                                <td><span class="fw-bold">${fechaFmt}</span> <span class="text-muted small">${cita.hora_inicio}</span></td>
                                <td><div class="fw-bold text-dark">${cita.nombre_contacto}</div><div class="small text-muted">${cita.telefono_contacto || ''}</div></td>
                                <td><span class="badge bg-light text-dark border">${cita.motivo || '-'}</span></td>
                            </tr>`;
                        });
                        html += `</tbody></table></div>`;
                        contenedor.innerHTML = html;
                    } else {
                        contenedor.innerHTML = '<div class="alert alert-warning text-center">No hay visitas registradas.</div>';
                    }
                } catch (e) {
                    console.error(e);
                    contenedor.innerHTML = '<p class="text-danger text-center">Error cargando visitas.</p>';
                }
            }

            function toggleAllOV(source) {
                document.querySelectorAll('.ov-check').forEach(c => c.checked = source.checked);
            }

            // 3. PREPARAR PREVISUALIZACIÓN (PASO 3) - ¡AQUÍ ESTABA EL PROBLEMA!
            function prepararPrevisualizacion() {
                // A. Si no hay datos, creamos un objeto vacío para que no falle
                if (!propiedadData) {
                    console.warn("PropiedadData es null. Usando fallback.");
                    propiedadData = {
                        id: propId,
                        titulo_publicacion: 'Propiedad Sin Datos',
                        tipo_propiedad: 'Casa',
                        comuna: 'Santiago',
                        direccion_calle: 'Calle',
                        direccion_numero: '123',
                        dormitorios: 0,
                        banos: 0,
                        superficie_util: 0,
                        precio_venta: 0,
                        moneda_venta: 'UF',
                        operacion_venta: true,
                        imagen_principal: null
                    };
                }

                // B. Variables de Texto
                const tituloInput = document.getElementById('informe_titulo');
                const tituloFull = tituloInput ? tituloInput.value : 'Informe de Gestión';

                // Intentar extraer Mes y Año
                let mes = 'Gestión';
                let anio = new Date().getFullYear();
                try {
                    const partes = tituloFull.replace('Informe ', '').split(' ');
                    if (partes.length > 0) mes = partes[0];
                    if (partes.length > 1) anio = partes[partes.length - 1];
                } catch (e) { }

                // C. Imagen y Precio
                const imagenFondo = propiedadData.imagen_principal
                    ? `${API_URL}${propiedadData.imagen_principal}`
                    : 'https://placehold.co/800x600?text=Foto+Propiedad';

                const operacion = propiedadData.operacion_venta ? 'Venta' : 'Arriendo';
                const precioVal = propiedadData.operacion_venta ? propiedadData.precio_venta : propiedadData.precio_arriendo;
                const monedaVal = propiedadData.operacion_venta ? propiedadData.moneda_venta : propiedadData.moneda_arriendo;

                const precioFmt = `${monedaVal || '$'} ${(parseInt(precioVal) || 0).toLocaleString('es-CL')}`;

                // D. Construir HTML
                const html = `
                <div class="rep-header">
                    <img src="Logo_MG.jpeg" class="rep-logo" onerror="this.style.display='none'">
                    <div style="font-size:0.8rem; color:#888;">https://marlenguzman.cl</div>
                </div>

                <div class="rep-hero">
                    <div class="rep-hero-left">
                        <h1>Informe</h1>
                        <h2>${mes}</h2>
                        <div class="year">${anio}</div>
                    </div>
                    <div class="rep-hero-right" style="background-image: url('${imagenFondo}');"></div>
                </div>

                <div class="rep-details">
                    <span class="rep-cod">COD: ${propiedadData.id}</span>
                    <div class="rep-type">${propiedadData.tipo_propiedad || 'Propiedad'} en ${propiedadData.comuna || 'Chile'}</div>
                    <div class="rep-loc"><i class="bi bi-geo-alt-fill"></i> ${propiedadData.direccion_calle || ''} ${propiedadData.direccion_numero || ''}</div>
                    <div class="rep-specs">
                        <span><i class="bi bi-door-open"></i> ${propiedadData.dormitorios || 0} Dorm.</span>
                        <span><i class="bi bi-droplet"></i> ${propiedadData.banos || 0} Baños</span>
                        <span><i class="bi bi-aspect-ratio"></i> ${propiedadData.superficie_util || 0} m²</span>
                    </div>
                    <div class="rep-price">${operacion}: ${precioFmt}</div>
                </div>

                <div class="rep-section" id="sec-visitas-pdf" style="display:none;">
                    <div class="rep-sec-header"><div class="rep-sec-icon"><i class="bi bi-people"></i></div> Visitas Realizadas</div>
                    <table class="rep-table">
                        <thead><tr><th>Fecha</th><th>Cliente</th><th>Comentarios</th></tr></thead>
                        <tbody id="rep-body-visitas"></tbody>
                    </table>
                </div>

                <div class="rep-section" id="sec-portales-pdf" style="display:none;">
                    <div class="rep-sec-header"><div class="rep-sec-icon"><i class="bi bi-globe"></i></div> Publicación</div>
                    <div class="row g-3 text-center mt-1">
                         <div class="col-3"><div class="border p-2 rounded fw-bold text-secondary small">Portal Inmobiliario</div></div>
                         <div class="col-3"><div class="border p-2 rounded fw-bold text-secondary small">Yapo.cl</div></div>
                         <div class="col-3"><div class="border p-2 rounded fw-bold text-secondary small">TocToc</div></div>
                         <div class="col-3"><div class="border p-2 rounded fw-bold text-secondary small">Web Propia</div></div>
                    </div>
                </div>

                <div class="rep-footer">
                    <div>
                        <div class="agent-name">Marlen Teresita Guzman</div>
                        <div class="agent-contact">Agente Inmobiliario</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="agent-contact">+56 9 5228 6689</div>
                        <div class="agent-contact">marlenguzman.mg@gmail.com</div>
                    </div>
                </div>
            `;

                document.getElementById('preview-informe').innerHTML = html;

                // E. Inyectar Visitas Seleccionadas
                const checkboxes = document.querySelectorAll('.ov-check:checked');
                const tbody = document.getElementById('rep-body-visitas');
                const secVisitas = document.getElementById('sec-visitas-pdf');
                const optOv = document.getElementById('opt_ov'); // Radio button (si existe)

                // Verificamos si el radio button "Si" está chequeado. 
                // OJO: opt_ov es un nombre de grupo, buscamos el chequeado
                const showVisitas = document.querySelector('input[name="opt_ov"]:checked').value === 'si';

                if (checkboxes.length > 0 && showVisitas) {
                    secVisitas.style.display = 'block';
                    checkboxes.forEach(chk => {
                        const row = chk.closest('tr');
                        const celdas = row.querySelectorAll('td');
                        // Extraer texto seguro
                        const fecha = celdas[1] ? celdas[1].innerText : '-';
                        const clienteEl = celdas[2] ? celdas[2].querySelector('.fw-bold') : null;
                        const cliente = clienteEl ? clienteEl.innerText : (celdas[2] ? celdas[2].innerText : '-');
                        const motivoEl = celdas[3] ? celdas[3].querySelector('.badge') : null;
                        const motivo = motivoEl ? motivoEl.innerText : (celdas[3] ? celdas[3].innerText : '-');

                        tbody.innerHTML += `<tr><td>${fecha}</td><td>${cliente}</td><td>${motivo}</td></tr>`;
                    });
                }

                // F. Mostrar Portales
                const showPortales = document.querySelector('input[name="opt_portales"]:checked').value === 'si';
                if (showPortales) {
                    document.getElementById('sec-portales-pdf').style.display = 'block';
                }
            }

            // 4. GENERAR PDF (FINAL)
            async function guardarInforme() {
                const btn = document.querySelector('#contenido-paso-3 .btn-success');
                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando PDF...';
                btn.disabled = true;

                try {
                    const elemento = document.getElementById('preview-informe');
                    const titulo = document.getElementById('informe_titulo').value;

                    const opt = {
                        margin: 0,
                        filename: `Informe_${titulo.replace(/\s+/g, '_')}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    await html2pdf().set(opt).from(elemento).save();

                    // Guardar en BD (Opcional)
                    await fetch(`${API_URL}/api/propiedades/${propId}/informes`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ titulo: titulo, config: {} })
                    });

                    cambiarPaso(3, 4); // Éxito

                } catch (e) {
                    console.error(e);
                    alert("Error generando PDF: " + e.message);
                } finally {
                    btn.innerHTML = textoOriginal;
                    btn.disabled = false;
                }
            }

            // 5. NAVEGACIÓN WIZARD
            function mostrarWizard() {
                document.getElementById('vista-listado').style.display = 'none';
                document.getElementById('vista-wizard').style.display = 'block';
                resetPasos();
            }
            function cancelarWizard() {
                document.getElementById('vista-wizard').style.display = 'none';
                document.getElementById('vista-listado').style.display = 'block';
                cargarInformes();
            }
            function cambiarPaso(actual, siguiente) {
                document.getElementById(`contenido-paso-${actual}`).style.display = 'none';
                document.getElementById(`contenido-paso-${siguiente}`).style.display = 'block';
                for (let i = 1; i <= 4; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (i <= siguiente) step.classList.add('active'); else step.classList.remove('active');
                }
                const pct = (siguiente - 1) * 33;
                document.getElementById('progress-bar').style.width = pct + '%';
            }
            function irPaso2() { cambiarPaso(1, 2); cargarOrdenesVisita(); }
            function volverPaso1() { cambiarPaso(2, 1); }
            function irPaso3() {
                prepararPrevisualizacion(); // Llamada segura
                cambiarPaso(2, 3);
            }
            function volverPaso2() { cambiarPaso(3, 2); }
            function resetPasos() {
                for (let i = 1; i <= 4; i++) document.getElementById(`contenido-paso-${i}`).style.display = 'none';
                document.getElementById('contenido-paso-1').style.display = 'block';
                document.getElementById('progress-bar').style.width = '0%';
                for (let i = 1; i <= 4; i++) document.getElementById(`step${i}`).classList.remove('active');
                document.getElementById('step1').classList.add('active');
            }

            function configurarLinks(id) {
                document.getElementById('sidebar_cod').textContent = `Propiedad #${id}`;
                document.getElementById('link_editar').href = `admin-editar-propiedad.html?id=${id}`;
                document.getElementById('link_imagenes').href = `admin-propiedad-imagenes.html?id=${id}`;
                document.getElementById('link_documentos').href = `admin-propiedad-documentos.html?id=${id}`;
                document.getElementById('link_estado').href = `admin-propiedad-estado.html?id=${id}`;
                document.getElementById('link_bitacora').href = `admin-propiedad-bitacora.html?id=${id}`;
                document.getElementById('link_propietario').href = `admin-propiedad-propietario.html?id=${id}`;
            }

            async function cargarInformes() {
                const cont = document.getElementById('lista-informes');
                try {
                    const res = await fetch(`${API_URL}/api/propiedades/${propId}/informes`);
                    const json = await res.json();
                    if (json.success && json.data.length > 0) {
                        let html = `<div class="table-responsive"><table class="table table-hover align-middle"><thead class="table-light"><tr><th>Fecha</th><th>Título</th><th>Estado</th><th class="text-end">Acciones</th></tr></thead><tbody>`;
                        json.data.forEach(inf => {
                            const fecha = new Date(inf.fecha_generacion).toLocaleDateString();
                            html += `<tr><td>${fecha}</td><td class="fw-bold text-primary">${inf.titulo}</td><td><span class="badge bg-secondary">Generado</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary"><i class="bi bi-file-pdf"></i></button></td></tr>`;
                        });
                        html += `</tbody></table></div>`;
                        cont.innerHTML = html;
                    } else {
                        cont.innerHTML = `<div class="alert alert-light border text-center py-5"><h5 class="text-muted">No hay informes</h5><button class="btn btn-sm btn-outline-primary rounded-pill mt-2" onclick="mostrarWizard()">Generar ahora</button></div>`;
                    }
                } catch (e) { console.error(e); cont.innerHTML = '<p class="text-danger text-center">Error al cargar informes.</p>'; }
            }
        </script>
        <script src="admin-auth.js"></script>
</body>

</html>