<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propiedades - Nexxos Admin</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Open Sans', sans-serif;
            font-size: 0.85rem;
            color: #555;
        }

        /* --- NAVBAR (Gris Oscuro) --- */
        .navbar-nexxos {
            background-color: #343a40;
            padding: 10px 20px;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
        }

        .nav-link {
            color: #adb5bd !important;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .nav-link:hover,
        .nav-link.active {
            color: #fff !important;
        }

        .user-info {
            color: #fff;
            font-size: 0.8rem;
            text-align: right;
            line-height: 1.2;
        }

        /* --- ENCABEZADO --- */
        .page-header {
            background-color: #fff;
            padding: 15px 30px;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 1.6rem;
            color: #6c757d;
            margin: 0;
            font-weight: 300;
        }

        .breadcrumb {
            font-size: 0.8rem;
            color: #adb5bd;
            margin: 0;
        }

        /* --- BARRA DE FILTROS --- */
        .filters-container {
            background-color: #fff;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .count-text {
            color: #198754;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .active-filter {
            color: #dc3545;
            font-size: 0.8rem;
            cursor: pointer;
        }

        /* Botones de Vista (Verdes y Grises) */
        .btn-view {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            margin-right: 2px;
        }

        .btn-view:hover {
            background-color: #218838;
            color: white;
        }

        .btn-view-gray {
            background-color: #e2e6ea;
            color: #555;
            border: 1px solid #ced4da;
            padding: 4px 8px;
        }

        .btn-filter-main {
            background-color: #6c757d;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 15px;
            border-radius: 20px;
            /* Redondeado como en la foto */
            border: none;
        }

        /* --- TABLA --- */
        .table-container {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: hidden;
        }

        .table-nexxos {
            margin-bottom: 0;
        }

        .table-nexxos thead th {
            background-color: #fff;
            border-bottom: 2px solid #dee2e6;
            color: #333;
            font-weight: 700;
            font-size: 0.8rem;
            padding: 12px;
            vertical-align: middle;
        }

        .table-nexxos tbody td {
            padding: 12px;
            vertical-align: top;
            border-bottom: 1px solid #f2f2f2;
            font-size: 0.8rem;
        }

        .table-nexxos tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* Columnas ordenables */
        th.sortable {
            cursor: pointer;
        }

        th.sortable::after {
            content: ' \25BE';
            color: #ccc;
            font-size: 0.7rem;
            float: right;
        }

        /* Miniaturas */
        .img-wrapper {
            width: 100px;
            height: 75px;
            background-color: #eee;
            position: relative;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .check-select {
            margin-top: 5px;
            color: #0d6efd;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Badges (Etiquetas) */
        .badge-custom {
            padding: 4px 8px;
            border-radius: 3px;
            color: white;
            font-weight: 600;
            font-size: 0.7rem;
            display: inline-block;
            text-align: center;
            min-width: 60px;
        }

        .bg-blue {
            background-color: #007bff;
        }

        /* Venta */
        .bg-cyan {
            background-color: #17a2b8;
        }

        /* Arriendo */
        .bg-green {
            background-color: #28a745;
        }

        /* Activa */
        .bg-gray {
            background-color: #6c757d;
        }

        /* Borrador */

        /* Acciones */
        .btn-action-row {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .btn-table {
            background: #fff;
            border: 1px solid #ccc;
            color: #555;
            font-size: 0.75rem;
            padding: 2px 8px;
            text-align: left;
            border-radius: 3px;
        }

        .btn-table i {
            margin-right: 5px;
        }

        .btn-table.ficha i {
            color: #28a745;
        }

        .btn-table.share i {
            color: #dc3545;
        }

        /* Paginación */
        .pagination-bar {
            padding: 10px 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
        }

        .page-link {
            color: #007bff;
            font-size: 0.8rem;
        }

        .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }

        /* --- ESTILOS MENÚ FLOTANTE (COMPARTIR) --- */
        .share-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            z-index: 9999;
            /* Muy alto para que flote sobre todo */
            display: none;
            /* Oculto por defecto */
            min-width: 180px;
        }

        .share-menu.show {
            display: block;
            /* Se muestra al agregar la clase 'show' */
            animation: fadeIn 0.2s ease-in-out;
        }

        .share-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            color: #555;
            text-decoration: none;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .share-item:hover {
            background-color: #f8f9fa;
            color: #0d6efd;
        }

        .share-item i {
            font-size: 1.1rem;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        /* Colores de Marca */
        .share-item.whatsapp i {
            color: #25D366;
        }

        .share-item.facebook i {
            color: #1877F2;
        }

        .share-item.linkedin i {
            color: #0077b5;
        }

        .share-item.copy i {
            color: #6c757d;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- ESTILOS MODAL FICHA TIPO NEXXOS --- */
        .modal-nexxos .modal-header {
            background-color: #2c3e50;
            /* Azul oscuro Nexxos */
            color: white;
            border-bottom: none;
            padding: 15px 20px;
        }

        .modal-nexxos .modal-title {
            font-weight: 600;
            font-size: 1.1rem;
            text-transform: uppercase;
        }

        .modal-nexxos .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
            /* Equis blanca */
        }

        /* Pestañas Superiores */
        .nav-tabs-nexxos {
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
            padding: 10px 20px 0;
            gap: 5px;
            display: flex;
        }

        .nav-tabs-nexxos .nav-link {
            border: 1px solid transparent;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            color: #6c757d;
            background: transparent;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 8px 15px;
            cursor: pointer;
        }

        .nav-tabs-nexxos .nav-link.active {
            background-color: #fff;
            border-color: #dee2e6 #dee2e6 #fff;
            color: #343a40;
            border-top: 3px solid #2c3e50;
            /* Línea azul arriba */
        }

        .nav-tabs-nexxos .nav-link i {
            margin-right: 5px;
        }

        /* Contenido del Modal */
        .ficha-content {
            padding: 20px;
            background-color: #fff;
            min-height: 400px;
        }

        /* Caja de Precio */
        .price-box {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
        }

        .price-box .tag {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .price-box .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #0d6efd;
            /* Azul precio */
        }

        .price-box .value-clp {
            font-size: 0.9rem;
            color: #6c757d;
        }

        /* Info Grid */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .info-row label {
            font-weight: 600;
            color: #333;
        }

        /* Galería */
        .gallery-placeholder {
            background-color: #eee;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .gallery-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Botón Seleccionar (Naranja) */
        .btn-select-orange {
            background-color: #f39c12;
            /* Naranja Nexxos */
            border: none;
            color: white;
            font-weight: 600;
            padding: 10px 30px;
        }

        .btn-select-orange:hover {
            background-color: #e67e22;
            color: white;
        }
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark navbar-nexxos">
        <div class="container-fluid">
            <a class="navbar-brand" href="admin-dashboard.html">nexxos</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="admin-dashboard.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Sistema</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Clientes</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#">Propiedades</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Reportes</a></li>
                    <li class="nav-item"><a class="nav-link" href="admin-publicar-1.html">+ Publicar</a></li>
                </ul>
                <div class="user-info">
                    <div class="fw-bold">viernes, 16 de enero de 2026</div>
                    <div class="text-info" style="font-size:0.75rem">UF 39.744,55</div>
                    <div>Marlen Teresita <i class="bi bi-person-circle"></i></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="page-header">
        <h2 class="page-title">Propiedades</h2>
        <div class="breadcrumb">Panel de Control • Propiedades</div>
    </div>

    <div class="container-fluid px-4">

        <div class="filters-container">
            <div>
                <span class="count-text" id="totalProps">Cargando...</span> <span
                    class="text-muted small">encontradas</span>
                <div class="mt-1">
                    <small class="text-muted">Estado:</small> <span class="active-filter">Activa <i
                            class="bi bi-x"></i></span>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-view rounded"><i class="bi bi-arrow-down-up"></i></button>
                <button class="btn btn-view rounded"><i class="bi bi-layout-split"></i></button>
                <button class="btn btn-view rounded"><i class="bi bi-layout-three-columns"></i></button>

                <div class="vr mx-2"></div>

                <button class="btn btn-view-gray rounded"><i class="bi bi-list-ul"></i></button>
                <button class="btn btn-view-gray rounded"><i class="bi bi-grid-3x3-gap"></i></button>
                <button class="btn btn-view-gray rounded"><i class="bi bi-geo-alt"></i></button>

                <button class="btn btn-filter-main ms-3">FILTRAR LISTADO <i class="bi bi-funnel-fill"></i></button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <div class="input-group">
                    <input type="text" class="form-control form-control-sm" placeholder="buscar...">
                    <button class="btn btn-warning text-white btn-sm"><i class="bi bi-search"></i></button>
                </div>
            </div>
            <div class="col-md-8 d-flex justify-content-end">
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="paginacionTop"></ul>
                </nav>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-nexxos">
                <thead>
                    <tr>
                        <th width="120">Imagen</th>
                        <th class="sortable">Código</th>
                        <th class="sortable">Tipo</th>
                        <th class="sortable">Operación</th>
                        <th class="sortable">Estado</th>
                        <th class="sortable">Captador</th>
                        <th class="sortable">Dirección</th>
                        <th class="sortable">Precio</th>
                        <th class="sortable">Comuna</th>
                        <th class="sortable">Región</th>
                        <th>Editar</th>
                    </tr>
                </thead>
                <tbody id="tablaCuerpo">
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <div class="spinner-border text-primary mb-2"></div>
                            <p class="text-muted">Conectando con base de datos...</p>
                        </td>
                    </tr>
                </tbody>
            </table>

            <div class="pagination-bar">
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="paginacionBottom"></ul>
                </nav>
            </div>
        </div>

        <div class="text-center mt-4 mb-5 small text-muted">
            2026 © Convecta. Todos los derechos reservados.
        </div>
    </div>
    <div id="shareMenu" class="share-menu">
        <a href="#" class="share-item whatsapp" onclick="compartirRed('whatsapp')">
            <i class="bi bi-whatsapp"></i> WhatsApp
        </a>
        <a href="#" class="share-item facebook" onclick="compartirRed('facebook')">
            <i class="bi bi-facebook"></i> Facebook
        </a>
        <a href="#" class="share-item linkedin" onclick="compartirRed('linkedin')">
            <i class="bi bi-linkedin"></i> LinkedIn
        </a>
        <hr class="my-1">
        <a href="#" class="share-item copy" onclick="compartirRed('copy')">
            <i class="bi bi-link-45deg"></i> Copiar Enlace
        </a>
    </div>

    <div class="modal fade modal-nexxos" id="modalFicha" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">FICHA PROPIEDAD</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="nav-tabs-nexxos">
                    <button class="nav-link active" onclick="switchTab('propiedad')"><i
                            class="bi bi-house-door-fill"></i> Propiedad</button>
                    <button class="nav-link" onclick="switchTab('reportes')"><i class="bi bi-graph-up"></i>
                        Reportes</button>
                    <button class="nav-link" onclick="switchTab('interesados')"><i class="bi bi-people-fill"></i>
                        Interesados</button>
                    <button class="nav-link" onclick="switchTab('bitacora')"><i class="bi bi-chat-left-text-fill"></i>
                        Bitácora</button>
                    <button class="nav-link" onclick="switchTab('portales')"><i class="bi bi-laptop"></i>
                        Portales</button>
                    <button class="nav-link" onclick="switchTab('tareas')"><i class="bi bi-bell-fill"></i>
                        Tareas</button>
                </div>

                <div class="modal-body p-0">
                    <div id="tab-propiedad" class="ficha-content">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="gallery-placeholder">
                                    <img id="modalImg" src="" alt="Propiedad">
                                    <button class="btn btn-light btn-sm position-absolute start-0 ms-2"><i
                                            class="bi bi-chevron-left"></i></button>
                                    <button class="btn btn-light btn-sm position-absolute end-0 me-2"><i
                                            class="bi bi-chevron-right"></i></button>
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm rounded-circle"><i
                                            class="bi bi-facebook"></i></button>
                                    <button class="btn btn-outline-success btn-sm rounded-circle"><i
                                            class="bi bi-whatsapp"></i></button>
                                    <button class="btn btn-outline-secondary btn-sm rounded-circle"><i
                                            class="bi bi-share"></i></button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="d-flex justify-content-between">
                                    <span class="text-primary fw-bold" id="modalCodigo">Cód: 000</span>
                                    <span class="badge bg-warning text-dark" id="modalEstado">Novedad</span>
                                </div>
                                <h4 class="mt-2 mb-0 fw-bold" id="modalTipo">Departamento</h4>
                                <p class="text-muted small mb-3">
                                    <i class="bi bi-geo-alt-fill"></i> <span id="modalDireccion">Dirección...</span>
                                </p>

                                <div class="price-box">
                                    <span class="tag" id="modalTagOperacion">VENTA</span>
                                    <div class="value" id="modalPrecio">UF 0.000</div>
                                    <div class="value-clp" id="modalPrecioPesos">$ 0 aprox</div>
                                </div>

                                <div class="card bg-light border-0 p-3 mb-3">
                                    <div class="fw-bold text-white bg-dark px-2 py-1 rounded mb-2 d-inline-block">
                                        Información</div>
                                    <div class="info-row">
                                        <label>Dormitorios:</label> <span id="modalDorms">0</span>
                                    </div>
                                    <div class="info-row">
                                        <label>Baños:</label> <span id="modalBanos">0</span>
                                    </div>
                                    <div class="info-row">
                                        <label>Superficie:</label> <span id="modalSup">0 m²</span>
                                    </div>
                                    <div class="info-row border-0">
                                        <label>Gastos Comunes:</label> <span>$ 33.000</span>
                                    </div>
                                </div>

                                <div>
                                    <h6 class="text-primary border-bottom pb-1">Descripción</h6>
                                    <p class="small text-muted" id="modalDesc"
                                        style="max-height: 100px; overflow-y: auto;">
                                        Descripción de la propiedad...
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-otros" class="ficha-content text-center py-5" style="display: none;">
                        <i class="bi bi-cone-striped display-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">Módulo en desarrollo</h4>
                        <p>Esta pestaña se mostrará próximamente.</p>
                    </div>
                </div>

                <div class="modal-footer bg-dark border-0 justify-content-center">
                    <button type="button" class="btn btn-select-orange rounded-1">
                        <i class="bi bi-check2-square"></i> Seleccionar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // VARIABLE GLOBAL PARA GUARDAR LOS DATOS
        let listaPropiedadesGlobal = [];

        document.addEventListener('DOMContentLoaded', () => {
            cargarPropiedades(1);
        });

        async function cargarPropiedades(pagina) {
            try {
                const res = await fetch(`http://localhost:3000/api/propiedades-list?page=${pagina}&limit=15`);
                const data = await res.json();

                if (data.success) {
                    // GUARDAMOS LOS DATOS EN LA VARIABLE GLOBAL
                    listaPropiedadesGlobal = data.data;

                    document.getElementById('totalProps').innerText = `${data.pagination.totalItems} PROPIEDADES`;
                    pintarTabla(data.data);
                    pintarPaginacion(data.pagination);
                } else {
                    mostrarError(data.message);
                }
            } catch (error) {
                console.error(error);
                mostrarError("No se pudo conectar con el servidor.");
            }
        }

        // --- FUNCIÓN QUE ABRE LA FICHA (NUEVA) ---
        function verFicha(id) {
            // 1. Buscar la propiedad en la memoria
            const prop = listaPropiedadesGlobal.find(p => p.id === id);

            if (!prop) {
                alert("Error: No se encontraron los datos de la propiedad ID " + id);
                return;
            }

            // 2. Llenar los campos del Modal
            document.getElementById('modalCodigo').innerText = 'Cód: ' + prop.id;
            document.getElementById('modalTipo').innerText = prop.tipo_propiedad;
            document.getElementById('modalDireccion').innerText = (prop.direccion_calle || '') + ' ' + (prop.direccion_numero || '') + ', ' + prop.comuna;

            // Imagen
            const imgUrl = prop.imagen_principal || 'https://placehold.co/600x400?text=Sin+Imagen';
            document.getElementById('modalImg').src = imgUrl;

            // Precio y Operación
            if (prop.operacion_venta) {
                document.getElementById('modalTagOperacion').innerText = 'VENTA';
                document.getElementById('modalTagOperacion').className = 'tag text-primary';
                document.getElementById('modalPrecio').innerText = (prop.moneda_venta || 'UF') + ' ' + Number(prop.precio_venta).toLocaleString('es-CL');
                // Simulación de conversión a pesos (opcional)
                document.getElementById('modalPrecioPesos').innerText = '$ ' + (prop.precio_venta * 38000).toLocaleString('es-CL') + ' aprox';
            } else {
                document.getElementById('modalTagOperacion').innerText = 'ARRIENDO';
                document.getElementById('modalTagOperacion').className = 'tag text-success';
                document.getElementById('modalPrecio').innerText = (prop.moneda_arriendo || '$') + ' ' + Number(prop.precio_arriendo).toLocaleString('es-CL');
                document.getElementById('modalPrecioPesos').innerText = '';
            }

            // Datos técnicos
            document.getElementById('modalDorms').innerText = prop.dormitorios || 0;
            document.getElementById('modalBanos').innerText = prop.banos || 0;
            document.getElementById('modalSup').innerText = (prop.superficie_util || 0) + ' m²';
            document.getElementById('modalDesc').innerText = "Excelente oportunidad en " + prop.comuna + ". Contáctanos para más información."; // Texto simulado si no viene de la API

            // 3. Abrir el Modal usando Bootstrap 5
            const modalElement = document.getElementById('modalFicha');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }

        // Función para cambiar pestañas dentro del modal (Visual)
        function switchTab(tabName) {
            // Quitar active de todos los botones
            document.querySelectorAll('.nav-tabs-nexxos .nav-link').forEach(btn => btn.classList.remove('active'));
            // Poner active al clickeado (truco simple buscando por el onclick)
            event.currentTarget.classList.add('active');

            if (tabName === 'propiedad') {
                document.getElementById('tab-propiedad').style.display = 'block';
                document.getElementById('tab-otros').style.display = 'none';
            } else {
                document.getElementById('tab-propiedad').style.display = 'none';
                document.getElementById('tab-otros').style.display = 'block';
                // Aquí podrías personalizar el mensaje según la pestaña (Reportes, Bitácora, etc.)
            }
        }

        // --- (Mantener funciones pintarTabla, pintarPaginacion, mostrarError, etc.) ---
        function pintarTabla(propiedades) {
            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = '';

            if (propiedades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center py-5 text-muted">No se encontraron propiedades.</td></tr>';
                return;
            }

            propiedades.forEach(prop => {
                let opHtml = '';
                if (prop.operacion_venta) opHtml += '<span class="badge-custom bg-blue mb-1">Venta</span><br>';
                if (prop.operacion_arriendo) opHtml += '<span class="badge-custom bg-cyan">Arriendo</span>';

                let estadoClass = prop.estado_publicacion === 'PUBLICADA' ? 'bg-green' : 'bg-gray';
                let estadoTxt = prop.estado_publicacion === 'PUBLICADA' ? 'Activa' : 'Borrador';

                let precioHtml = '';
                if (prop.precio_venta) {
                    precioHtml += `<div class="fw-bold text-dark">${prop.moneda_venta || 'UF'} ${Number(prop.precio_venta).toLocaleString('es-CL')}</div>`;
                }
                if (prop.precio_arriendo) {
                    precioHtml += `<div class="small text-muted">${prop.moneda_arriendo || '$'} ${Number(prop.precio_arriendo).toLocaleString('es-CL')}</div>`;
                }

                let img = prop.imagen_principal || "https://placehold.co/150?text=Casa";

                const row = `
                    <tr>
                        <td>
                            <div class="img-wrapper"><img src="${img}"></div>
                            <div class="check-select"><i class="bi bi-square"></i> Seleccionar</div>
                        </td>
                        <td class="fw-bold text-secondary">#${prop.id}</td>
                        <td>${prop.tipo_propiedad || '-'}</td>
                        <td>${opHtml}</td>
                        <td><span class="badge-custom ${estadoClass}">${estadoTxt}</span></td>
                        <td>Marlen Teresita</td>
                        <td>
                            <div class="fw-bold">${prop.direccion_calle || ''} ${prop.direccion_numero || ''}</div>
                            <small class="text-muted">${prop.sector || ''}</small>
                        </td>
                        <td>${precioHtml}</td>
                        <td>${prop.comuna || ''}</td>
                        <td>${prop.region || ''}</td>
                        <td>
                            <div class="btn-action-row">
                                <button class="btn-table ficha" onclick="verFicha(${prop.id})">
                                    <i class="bi bi-search"></i> Ficha
                                </button>
                                <button class="btn-table" onclick="location.href='admin-editar-propiedad.html?id=${prop.id}'" style="border-color: #0d6efd; color: #0d6efd;">
                                    <i class="bi bi-pencil"></i> Editar
                                </button>
                                <button class="btn-table share" onclick="toggleShare(event, ${prop.id})">
                                    <i class="bi bi-share"></i> Compartir
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function pintarPaginacion(pag) {
            const html = [];
            const prevDisabled = pag.page === 1 ? 'disabled' : '';
            const nextDisabled = pag.page === pag.totalPages ? 'disabled' : '';

            html.push(`<li class="page-item ${prevDisabled}"><a class="page-link" href="#" onclick="cargarPropiedades(${pag.page - 1})">«</a></li>`);

            for (let i = 1; i <= pag.totalPages; i++) {
                const active = i === pag.page ? 'active' : '';
                html.push(`<li class="page-item ${active}"><a class="page-link" href="#" onclick="cargarPropiedades(${i})">${i}</a></li>`);
            }

            html.push(`<li class="page-item ${nextDisabled}"><a class="page-link" href="#" onclick="cargarPropiedades(${pag.page + 1})">»</a></li>`);

            document.getElementById('paginacionTop').innerHTML = html.join('');
            document.getElementById('paginacionBottom').innerHTML = html.join('');
        }

        function mostrarError(msg) {
            document.getElementById('tablaCuerpo').innerHTML = `<tr><td colspan="11" class="text-center text-danger py-5"><i class="bi bi-exclamation-triangle-fill display-4"></i><br>${msg}</td></tr>`;
        }

        // LÓGICA DE COMPARTIR (IGUAL QUE ANTES)
        let currentShareId = null;
        function toggleShare(event, id) {
            event.stopPropagation();
            const menu = document.getElementById('shareMenu');
            if (currentShareId === id && menu.classList.contains('show')) {
                menu.classList.remove('show');
                currentShareId = null;
                return;
            }
            currentShareId = id;
            const rect = event.currentTarget.getBoundingClientRect();
            menu.style.top = (window.scrollY + rect.bottom + 5) + 'px';
            menu.style.left = (window.scrollX + rect.left - 50) + 'px';
            menu.classList.add('show');
        }

        function compartirRed(red) {
            if (!currentShareId) return;
            const urlPropiedad = `http://localhost:3000/ficha-propiedad.html?id=${currentShareId}`;
            const texto = `¡Mira esta propiedad en Nexxos! ID: #${currentShareId}`;
            let shareUrl = "";

            switch (red) {
                case 'whatsapp': shareUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto + ' ' + urlPropiedad)}`; break;
                case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlPropiedad)}`; break;
                case 'linkedin': shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(urlPropiedad)}`; break;
                case 'copy':
                    navigator.clipboard.writeText(urlPropiedad).then(() => { alert("✅ Enlace copiado"); });
                    document.getElementById('shareMenu').classList.remove('show');
                    return;
            }
            if (shareUrl) window.open(shareUrl, '_blank', 'width=600,height=400');
            document.getElementById('shareMenu').classList.remove('show');
        }

        document.addEventListener('click', (e) => {
            const menu = document.getElementById('shareMenu');
            if (!menu.contains(e.target)) {
                menu.classList.remove('show');
                currentShareId = null;
            }
        });
    </script>



</body>

</html>
