<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agregar Propiedad - Paso 1</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/admin-sidebar.css">
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #555;
        }

        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        /* Pasos */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
            padding: 0 20px;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e9ecef;
            z-index: 1;
        }

        .step {
            z-index: 2;
            background: #fff;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #e9ecef;
            color: #adb5bd;
        }

        .step.active {
            background: #0d6efd;
            border-color: #0d6efd;
            color: white;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
        }

        .step-label {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: #adb5bd;
            text-align: center;
            position: absolute;
            width: 100px;
            margin-left: -32px;
            top: 40px;
        }

        .step.active+.step-label {
            color: #0d6efd;
            font-weight: 600;
        }

        /* Paneles */
        .disabled-panel {
            opacity: 0.5;
            pointer-events: none;
            background-color: #f8f9fa;
        }

        .operation-box {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }

        .operation-box:hover {
            border-color: #b1b7c1;
        }
    </style>
</head>

<body>

    <div class="sidebar"></div>

    <div class="main-content">

        <div class="container mt-5 mb-5">
            <div class="row justify-content-center">
                <div class="col-md-10">

                    <div class="d-flex justify-content-between align-items-end mb-4">
                        <div>
                            <small class="text-muted">Panel de Control • Agregar propiedad</small>
                            <h4 class="text-primary mt-1"><i class="fa fa-home"></i> AGREGAR PROPIEDAD - PASO 1 DE 6
                            </h4>
                        </div>
                        <small class="text-success fw-bold" id="borradorText">
                            <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Editando...
                        </small>
                    </div>

                    <div class="step-indicator px-4">
                        <div class="text-center">
                            <div class="step active">1</div><span class="step-label">Tipo</span>
                        </div>
                        <div class="text-center">
                            <div class="step">2</div><span class="step-label">Ubicación</span>
                        </div>
                        <div class="text-center">
                            <div class="step">3</div><span class="step-label">Características</span>
                        </div>
                        <div class="text-center">
                            <div class="step">4</div><span class="step-label">Observaciones</span>
                        </div>
                        <div class="text-center">
                            <div class="step">5</div><span class="step-label">Propietario</span>
                        </div>
                        <div class="text-center">
                            <div class="step">6</div><span class="step-label">Confirmar</span>
                        </div>
                    </div>

                    <div class="progress mb-4" style="height: 5px;">
                        <div class="progress-bar" style="width: 16%;"></div>
                    </div>

                    <div class="card p-4">
                        <form id="formPaso1">

                            <h5 class="mb-3 text-dark border-bottom pb-2">Tipo, rol y exclusividad</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Tipo de propiedad <span
                                            class="text-danger">*</span></label>
                                    <select class="form-select required-field" id="tipoPropiedad">
                                        <option value="">Seleccione...</option>
                                        <option value="Casa" selected>Casa</option>
                                        <option value="Departamento">Departamento</option>
                                        <option value="Oficina">Oficina</option>
                                        <option value="Sitio">Sitio</option>
                                        <option value="Local Comercial">Local Comercial</option>
                                        <option value="Industrial">Industrial</option>
                                        <option value="Agrícola">Agrícola</option>
                                        <option value="Parcela">Parcela</option>
                                        <option value="Estacionamiento">Estacionamiento</option>
                                        <option value="Terreno Construccion">Terreno Construccion</option>
                                        <option value="Bodega">Bodega</option>
                                        <option value="Negocio/Patentes/Derechos de llave">Negocio/Patentes/Derechos de
                                            llave</option>
                                        <option value="Residencial/Pieza">Residencial/Pieza</option>
                                        <option value="Hotel/Apart Hotel">Hotel/Apart Hotel</option>
                                        <option value="Complejos Turísticos">Complejos Turísticos</option>
                                        <option value="Departamento Amoblado">Departamento Amoblado</option>
                                    </select>
                                    <div class="form-text text-muted" style="font-size: 0.75rem; margin-top: 5px;">
                                        Seleccione al menos un tipo de propiedad. El primero que seleccione será el tipo
                                        principal.
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <label for="rolSii" class="form-label">Rol<span class="text-danger">*</span></label>
                                    <input type="text" class="form-control required-field" id="rolSii"
                                        placeholder="Ej: 00161-00032">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">
                                        Exclusividad
                                        <i class="bi bi-info-circle-fill text-primary" data-bs-toggle="tooltip"
                                            title="Información sobre exclusividad"></i>
                                    </label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="exclusividad" id="excSi" value="Si">
                                        <label class="btn btn-outline-primary" for="excSi">Sí</label>

                                        <input type="radio" class="btn-check" name="exclusividad" id="excNo" value="No"
                                            checked>
                                        <label class="btn btn-outline-primary" for="excNo">No</label>
                                    </div>
                                </div>
                            </div>

                            <h5 class="mb-3 mt-4 text-dark border-bottom pb-2">Operación <small
                                    class="text-muted fw-light" style="font-size: 0.8rem">Seleccione al menos
                                    una</small></h5>

                            <div class="row">

                                <div class="col-md-6">
                                    <div class="p-4 bg-light rounded border h-100">
                                        <h6 class="text-uppercase text-muted fw-bold mb-3">Venta</h6>

                                        <div class="mb-3">
                                            <div class="btn-group" role="group">
                                                <input type="radio" class="btn-check" name="opVenta" id="ventaSi"
                                                    autocomplete="off" onchange="toggleOperacion('Venta', true)">
                                                <label class="btn btn-outline-success btn-sm px-3 fw-bold"
                                                    for="ventaSi">Sí</label>

                                                <input type="radio" class="btn-check" name="opVenta" id="ventaNo"
                                                    autocomplete="off" checked
                                                    onchange="toggleOperacion('Venta', false)">
                                                <label class="btn btn-outline-danger btn-sm px-3 fw-bold"
                                                    for="ventaNo">No</label>
                                            </div>
                                        </div>

                                        <div id="fieldsVenta" style="opacity: 0.5; pointer-events: none;">
                                            <div class="row g-2 align-items-center mb-2">
                                                <div class="col-7">
                                                    <label class="form-label small fw-bold text-muted">Precio <i
                                                            class="bi bi-info-circle-fill text-primary"></i></label>
                                                    <input type="number" class="form-control" id="precioVenta" disabled>
                                                </div>
                                                <div class="col-5">
                                                    <div class="form-check mt-4">
                                                        <input class="form-check-input" type="checkbox" id="vValorM2"
                                                            disabled>
                                                        <label class="form-check-label small text-muted"
                                                            for="vValorM2">Valor por m²</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="monedaVenta"
                                                        id="vPeso" value="$" disabled>
                                                    <label class="form-check-label small text-muted"
                                                        for="vPeso">$</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="monedaVenta"
                                                        id="vUF" value="UF" checked disabled>
                                                    <label class="form-check-label small text-muted"
                                                        for="vUF">UF</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="monedaVenta"
                                                        id="vUSD" value="USD" disabled>
                                                    <label class="form-check-label small text-muted" for="vUSD">USD
                                                        $</label>
                                                </div>
                                            </div>
                                            <div class="col-7">
                                                <label class="form-label small fw-bold text-muted">Precio tasación <i
                                                        class="bi bi-info-circle-fill text-primary"></i></label>
                                                <input type="number" class="form-control" id="tasacionVenta" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="p-4 bg-light rounded border h-100">
                                        <h6 class="text-uppercase text-muted fw-bold mb-3">Arriendo</h6>

                                        <div class="d-flex align-items-center mb-3 gap-3">
                                            <div class="btn-group" role="group">
                                                <input type="radio" class="btn-check" name="opArriendo" id="arriendoSi"
                                                    autocomplete="off" onchange="toggleOperacion('Arriendo', true)">
                                                <label class="btn btn-outline-success btn-sm px-3 fw-bold"
                                                    for="arriendoSi">Sí</label>

                                                <input type="radio" class="btn-check" name="opArriendo" id="arriendoNo"
                                                    autocomplete="off" checked
                                                    onchange="toggleOperacion('Arriendo', false)">
                                                <label class="btn btn-outline-danger btn-sm px-3 fw-bold"
                                                    for="arriendoNo">No</label>
                                            </div>
                                            <div class="form-check pt-1">
                                                <input class="form-check-input" type="checkbox" id="esTemporada">
                                                <label class="form-check-label small text-muted" for="esTemporada">Es
                                                    por
                                                    temporada</label>
                                            </div>
                                        </div>

                                        <div id="fieldsArriendo" style="opacity: 0.5; pointer-events: none;">
                                            <div class="row g-2 align-items-center mb-2">
                                                <div class="col-7">
                                                    <label class="form-label small fw-bold text-muted">Precio <i
                                                            class="bi bi-info-circle-fill text-primary"></i></label>
                                                    <input type="number" class="form-control" id="precioArriendo"
                                                        disabled>
                                                </div>
                                                <div class="col-5">
                                                    <div class="form-check mt-4">
                                                        <input class="form-check-input" type="checkbox" id="aValorM2"
                                                            disabled>
                                                        <label class="form-check-label small text-muted"
                                                            for="aValorM2">Valor por m²</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="monedaArriendo"
                                                        id="aPeso" value="$" checked disabled>
                                                    <label class="form-check-label small text-muted"
                                                        for="aPeso">$</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="monedaArriendo"
                                                        id="aUF" value="UF" disabled>
                                                    <label class="form-check-label small text-muted"
                                                        for="aUF">UF</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="monedaArriendo"
                                                        id="aUSD" value="USD" disabled>
                                                    <label class="form-check-label small text-muted" for="aUSD">USD
                                                        $</label>
                                                </div>
                                            </div>
                                            <div class="col-7">
                                                <label class="form-label small fw-bold text-muted">Precio tasación <i
                                                        class="bi bi-info-circle-fill text-primary"></i></label>
                                                <input type="number" class="form-control" id="tasacionArriendo"
                                                    disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4 align-items-end">

                                <div class="col-md-2">
                                    <label class="form-label fw-bold small">Canje <span
                                            class="text-danger">*</span></label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="canje" id="canjeSi" value="Si">
                                        <label class="btn btn-outline-secondary btn-sm" for="canjeSi">Sí</label>

                                        <input type="radio" class="btn-check" name="canje" id="canjeNo" value="No"
                                            checked>
                                        <label class="btn btn-outline-secondary btn-sm" for="canjeNo">No</label>
                                    </div>
                                </div>

                                <div class="col-md-5">
                                    <label class="form-label fw-bold small">
                                        Gastos Comunes
                                        <i class="fas fa-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                                            title="Valor mensual aproximado"></i>
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-light">$</span>
                                        <input type="number" class="form-control" id="gastosComunes" placeholder="0">
                                    </div>
                                </div>

                                <div class="col-md-5">
                                    <label class="form-label fw-bold small">
                                        Contribuciones
                                        <i class="fas fa-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                                            title="Valor cuota trimestral"></i>
                                    </label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-light">$</span>
                                        <input type="number" class="form-control" id="contribuciones" placeholder="0">
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">

                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Deuda</label>
                                    <div class="input-group input-group-sm">
                                        <span class="input-group-text bg-light">$</span>
                                        <input type="number" class="form-control" id="deuda" placeholder="0">
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Hipoteca</label>
                                    <input type="text" class="form-control form-control-sm" id="hipoteca"
                                        placeholder="Nº o Detalle">
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label fw-bold small">Banco</label>
                                    <select class="form-select form-select-sm" id="banco">
                                        <option value="">Seleccione...</option>
                                        <option value="Banco BBVA">Banco BBVA</option>
                                        <option value="Banco BICE">Banco BICE</option>
                                        <option value="Banco Consorcio">Banco Consorcio</option>
                                        <option value="Banco de Chile">Banco de Chile</option>
                                        <option value="Banco de la Nación Argentina">Banco de la Nación Argentina
                                        </option>
                                        <option value="Banco do Brasil">Banco do Brasil</option>
                                        <option value="Banco Edwards">Banco Edwards</option>
                                        <option value="Banco Estado">Banco Estado</option>
                                        <option value="Banco Falabella">Banco Falabella</option>
                                        <option value="Banco Itau">Banco Itau</option>
                                        <option value="Banco París">Banco París</option>
                                        <option value="Banco Penta">Banco Penta</option>
                                        <option value="Banco Ripley">Banco Ripley</option>
                                        <option value="Banco Santander">Banco Santander</option>
                                        <option value="Banco Security">Banco Security</option>
                                        <option value="Bank Of Tokyo">Bank Of Tokyo</option>
                                        <option value="BCI">BCI</option>
                                        <option value="CorpBanca">CorpBanca</option>
                                        <option value="Deutsche Bank">Deutsche Bank</option>
                                        <option value="HSBC">HSBC</option>
                                        <option value="JP Morgan Chase Bank">JP Morgan Chase Bank</option>
                                        <option value="RaboBank">RaboBank</option>
                                        <option value="ScotiaBank">ScotiaBank</option>
                                    </select>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-5 pt-3 border-top">
                                <a href="admin-dashboard.html" class="btn btn-outline-secondary px-4">
                                    <i class="bi bi-x-circle"></i> Cancelar / Volver
                                </a>

                                <button type="button" class="btn btn-primary px-5 shadow" onclick="guardarYContinuar()">
                                    Siguiente <i class="bi bi-arrow-right"></i>
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ======================================================
        // 1. LÓGICA DE INICIO (RECUPERACIÓN DE DATOS)
        // ======================================================
        document.addEventListener('DOMContentLoaded', () => {
            // A. Intentar recuperar datos guardados previamente
            cargarDatosPrevios();

            // B. Inicializar estado visual de los paneles (Venta/Arriendo)
            // Esto asegura que si recuperamos "Venta: No", el panel aparezca apagado
            const ventaActiva = document.getElementById('ventaSi').checked;
            const arriendoActivo = document.getElementById('arriendoSi').checked;

            toggleOperacion('Venta', ventaActiva);
            toggleOperacion('Arriendo', arriendoActivo);
        });

        function cargarDatosPrevios() {
            // Buscamos si existe la "cajita" guardada
            const datosGuardados = localStorage.getItem('nuevaPropiedad_Paso1');

            // Si no existe (es primera vez), salimos y dejamos todo vacío
            if (!datosGuardados) return;

            console.log("Recuperando datos...", datosGuardados);
            const datos = JSON.parse(datosGuardados);

            // --- RELLENADO DE CAMPOS ---

            // 1. Tipo y Rol
            if (datos.tipo) document.getElementById('tipoPropiedad').value = datos.tipo;
            if (datos.rol) document.getElementById('rolSii').value = datos.rol;

            // 2. Exclusividad (Radio Button)
            if (datos.exclusividad === 'Sí') document.getElementById('excSi').checked = true;
            else document.getElementById('excNo').checked = true;

            // 3. Operación Venta
            if (datos.operacion.venta) {
                document.getElementById('ventaSi').checked = true;
                document.getElementById('precioVenta').value = datos.operacion.precioVenta || '';
                document.getElementById('tasacionVenta').value = datos.operacion.tasacionVenta || '';
                // Moneda Venta
                if (datos.operacion.monedaVenta) {
                    const radioMoneda = document.querySelector(`input[name="monedaVenta"][value="${datos.operacion.monedaVenta}"]`);
                    if (radioMoneda) radioMoneda.checked = true;
                }
            } else {
                document.getElementById('ventaNo').checked = true;
            }

            // 4. Operación Arriendo
            if (datos.operacion.arriendo) {
                document.getElementById('arriendoSi').checked = true;
                document.getElementById('precioArriendo').value = datos.operacion.precioArriendo || '';
                document.getElementById('tasacionArriendo').value = datos.operacion.tasacionArriendo || '';
                document.getElementById('esTemporada').checked = datos.operacion.esTemporada;
                // Moneda Arriendo
                if (datos.operacion.monedaArriendo) {
                    const radioMoneda = document.querySelector(`input[name="monedaArriendo"][value="${datos.operacion.monedaArriendo}"]`);
                    if (radioMoneda) radioMoneda.checked = true;
                }
            } else {
                document.getElementById('arriendoNo').checked = true;
            }

            // 5. Datos Financieros y Legales
            // Canje
            if (datos.canje === 'Sí') document.getElementById('canjeSi').checked = true;
            else document.getElementById('canjeNo').checked = true;

            if (datos.gastosComunes) document.getElementById('gastosComunes').value = datos.gastosComunes;
            if (datos.contribuciones) document.getElementById('contribuciones').value = datos.contribuciones;
            if (datos.deuda) document.getElementById('deuda').value = datos.deuda;
            if (datos.hipoteca) document.getElementById('hipoteca').value = datos.hipoteca;
            if (datos.banco) document.getElementById('banco').value = datos.banco;
        }

        // ======================================================
        // 2. CONTROL DE PANELES (TU CÓDIGO ORIGINAL)
        // ======================================================
        function toggleOperacion(tipo, activar) {
            const contenedor = document.getElementById('fields' + tipo);
            // Protegemos por si el ID no existe
            if (!contenedor) return;

            const inputs = contenedor.querySelectorAll('input, select');

            if (activar) {
                contenedor.style.opacity = "1";
                contenedor.style.pointerEvents = "auto";
                inputs.forEach(input => input.disabled = false);
            } else {
                contenedor.style.opacity = "0.5";
                contenedor.style.pointerEvents = "none";
                inputs.forEach(input => {
                    input.disabled = true;
                    // NOTA: Comenté la limpieza de valores para que NO se borren si desactivas y activas
                    // if (input.type === 'number') input.value = ''; 
                });
            }
        }

        // ======================================================
        // 3. FUNCIÓN DE GUARDADO (TU CÓDIGO ORIGINAL CON AJUSTES)
        // ======================================================
        function guardarYContinuar() {
            const tipo = document.getElementById('tipoPropiedad').value;
            const rol = document.getElementById('rolSii').value; // Nueva línea
            const isVenta = document.getElementById('ventaSi').checked;
            const isArriendo = document.getElementById('arriendoSi').checked;

            // Validación
            if (tipo === "") {
                alert("Por favor seleccione el Tipo de Propiedad.");
                return;
            }
            if (rol.trim() === "") { alert("El Rol de la propiedad es obligatorio."); return; } // Nueva validación
            if (!isVenta && !isArriendo) {
                alert("Debe seleccionar al menos una operación (Venta o Arriendo).");
                return;
            }

            // Recolectar Datos
            const datosPaso1 = {
                tipo: tipo,
                rol: document.getElementById('rolSii').value,
                exclusividad: document.getElementById('excSi').checked ? 'Sí' : 'No',
                operacion: {
                    venta: isVenta,
                    precioVenta: document.getElementById('precioVenta').value,
                    monedaVenta: getRadioValue('monedaVenta'),
                    tasacionVenta: document.getElementById('tasacionVenta').value,

                    arriendo: isArriendo,
                    precioArriendo: document.getElementById('precioArriendo').value,
                    monedaArriendo: getRadioValue('monedaArriendo'),
                    tasacionArriendo: document.getElementById('tasacionArriendo').value,
                    esTemporada: document.getElementById('esTemporada').checked
                },
                canje: document.getElementById('canjeSi').checked ? 'Sí' : 'No',
                gastosComunes: document.getElementById('gastosComunes').value,
                contribuciones: document.getElementById('contribuciones').value,
                deuda: document.getElementById('deuda').value,
                hipoteca: document.getElementById('hipoteca').value,
                banco: document.getElementById('banco').value
            };

            // Guardar
            localStorage.setItem('nuevaPropiedad_Paso1', JSON.stringify(datosPaso1));
            console.log("Datos Guardados Exitosamente");

            // Ir al Paso 2
            window.location.href = 'admin-publicar-paso2.html';
        }

        function getRadioValue(name) {
            const checkedRadio = document.querySelector(`input[name="${name}"]:checked`);
            return checkedRadio ? checkedRadio.value : '';
        }
    </script>

    <script src="admin-auth.js"></script>
    <script src="js/admin-sidebar.js"></script>
</body>

</html>