<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes de Gestión - Nexxos Admin</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Segoe UI', sans-serif;
        }

        /* SIDEBAR (Mismo estilo que las otras páginas) */
        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background: #343a40;
            color: white;
            padding-top: 20px;
            z-index: 1000;
        }

        .sidebar-brand {
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .sidebar a {
            padding: 12px 20px;
            text-decoration: none;
            color: #adb5bd;
            display: block;
        }

        .sidebar a:hover {
            background: #495057;
            color: white;
        }

        .sidebar a.active {
            background: #495057;
            color: white;
            border-left: 4px solid #0d6efd;
            font-weight: 600;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
        }

        /* Estilos del Reporte (Hoja A4) */
        .report-sheet {
            background: white;
            padding: 40px;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            margin: 0 auto;
        }

        .report-header {
            border-bottom: 2px solid #bfa378;
            padding-bottom: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kpi-card {
            background: #f8f9fa;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .kpi-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .kpi-label {
            font-size: 0.85rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-brand"><i class="bi bi-building"></i> NEXXOS ADMIN</div>
        <a href="admin-dashboard.html"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
        <a href="admin-propiedades.html"><i class="bi bi-house-door me-2"></i> Propiedades</a>
        <a href="admin-agenda.html"><i class="bi bi-calendar-check me-2"></i> Agenda</a>
        <a href="admin-interesados.html"><i class="bi bi-people me-2"></i> Interesados (CRM)</a>
        <a href="admin-reportes.html" class="active"><i class="bi bi-bar-chart me-2"></i> Reportes</a>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4 container" style="max-width: 1000px;">
            <h4 class="fw-bold m-0">Generador de Reportes</h4>
            <button class="btn btn-danger" onclick="descargarPDF()">
                <i class="bi bi-file-earmark-pdf-fill me-2"></i> Descargar PDF
            </button>
        </div>

        <div class="report-sheet" id="area-impresion">

            <div class="report-header">
                <div>
                    <h2 class="fw-bold" style="color: #333;">Reporte de Gestión Mensual</h2>
                    <p class="text-muted m-0">Inmobiliaria Marlen Guzmán</p>
                </div>
                <div class="text-end">
                    <img src="Logo_MG.jpeg" height="60" alt="Logo">
                    <div class="small text-muted mt-2" id="report-date">Fecha: ...</div>
                </div>
            </div>

            <div class="row g-4 mb-5">
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-number text-primary" id="kpi-ventas">0</div>
                        <div class="kpi-label">Propiedades Vendidas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-number text-success" id="kpi-monto">UF 0</div>
                        <div class="kpi-label">Volumen de Ventas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-number text-warning" id="kpi-leads">0</div>
                        <div class="kpi-label">Nuevos Interesados</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="kpi-card">
                        <div class="kpi-number text-info" id="kpi-visitas">0</div>
                        <div class="kpi-label">Visitas Web (30 días)</div>
                    </div>
                </div>
            </div>

            <div class="row mb-5">
                <div class="col-md-6">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Embudo de Ventas (Leads)</h5>
                    <div style="height: 250px;">
                        <canvas id="chartLeads"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <h5 class="fw-bold mb-3 border-bottom pb-2">Estado del Inventario</h5>
                    <div style="height: 250px; display: flex; justify-content: center;">
                        <canvas id="chartInventario"></canvas>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h5 class="fw-bold mb-3 border-bottom pb-2">Últimos Cierres Exitosos</h5>
                <table class="table table-striped table-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>Propiedad</th>
                            <th>Fecha Cierre</th>
                            <th class="text-end">Monto Final</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-cierres">
                    </tbody>
                </table>
            </div>

            <div class="mt-5 text-center text-muted small border-top pt-3">
                <p>Generado automáticamente por el Sistema Nexxos Admin • Marlen Guzmán Gestión Inmobiliaria</p>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Poner fecha de hoy
            document.getElementById('report-date').innerText = `Fecha: ${new Date().toLocaleDateString()}`;
            cargarDatosReales();
        });

        async function cargarDatosReales() {
            try {
                // 1. Pedir datos al servidor
                const res = await fetch('http://localhost:3000/api/admin/reporte-mensual');
                const data = await res.json();

                if (!data.success) throw new Error("Error en datos");

                const inv = data.inventario;

                // 2. Llenar KPIs (Tarjetas de arriba)
                document.getElementById('kpi-ventas').innerText = inv.vendidas || 0;
                document.getElementById('kpi-monto').innerText = `UF ${parseInt(inv.monto_ventas_uf || 0).toLocaleString('es-CL')}`;
                document.getElementById('kpi-visitas').innerText = parseInt(data.visitas_mensuales || 0).toLocaleString('es-CL');

                // Calcular total de leads sumando los estados
                let totalLeads = 0;
                let leadsMap = { 'NUEVO': 0, 'CONTACTADO': 0, 'VISITA': 0, 'OFERTA': 0, 'CERRADO': 0 };

                data.leads_por_estado.forEach(item => {
                    leadsMap[item.estado] = parseInt(item.cantidad);
                    totalLeads += parseInt(item.cantidad);
                });
                document.getElementById('kpi-leads').innerText = totalLeads;

                // 3. Gráfico de Embudo (Leads)
                new Chart(document.getElementById('chartLeads'), {
                    type: 'bar',
                    data: {
                        labels: ['Nuevos', 'Contactados', 'Visitas', 'Ofertas', 'Cerrados'],
                        datasets: [{
                            label: 'Clientes',
                            data: [leadsMap['NUEVO'], leadsMap['CONTACTADO'], leadsMap['VISITA'], leadsMap['OFERTA'], leadsMap['CERRADO']],
                            backgroundColor: ['#dc3545', '#0d6efd', '#fd7e14', '#6f42c1', '#198754']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });

                // 4. Gráfico de Inventario (Pastel)
                new Chart(document.getElementById('chartInventario'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Disponibles', 'Vendidas', 'Arrendadas'],
                        datasets: [{
                            data: [inv.activas, inv.vendidas, inv.arrendadas],
                            backgroundColor: ['#bfa378', '#198754', '#0dcaf0']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // 5. Tabla de Cierres
                const tabla = document.getElementById('tabla-cierres');
                tabla.innerHTML = '';

                if (data.ultimos_cierres.length === 0) {
                    tabla.innerHTML = '<tr><td colspan="3" class="text-center">No hay ventas registradas este mes.</td></tr>';
                } else {
                    data.ultimos_cierres.forEach(c => {
                        tabla.innerHTML += `
                            <tr>
                                <td>${c.titulo_publicacion}</td>
                                <td>${new Date(c.fecha_publicacion || new Date()).toLocaleDateString()}</td>
                                <td class="text-end fw-bold">${c.moneda_venta} ${parseInt(c.precio_venta).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                }

            } catch (e) {
                console.error("Error cargando reporte:", e);
                alert("Error cargando datos del servidor");
            }
        }

        // --- FUNCIÓN PARA GENERAR PDF ---
        function descargarPDF() {
            const elemento = document.getElementById('area-impresion');
            const opciones = {
                margin: 10,
                filename: `Reporte_Gestion_${new Date().toISOString().slice(0, 10)}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Usamos la librería importada
            html2pdf().set(opciones).from(elemento).save();
        }
    </script>

</body>

</html>
