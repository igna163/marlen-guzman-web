<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Favoritos | Marlen GuzmÃ¡n</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/client-sidebar.css">
    <style>
        :root {
            --gold: #bfa378;
            --gold-light: #d4b88f;
            --dark: #3e3632;
            --cream: #f9f7f2;
            --white: #ffffff;
            --border: rgba(191, 163, 120, 0.2);
        }

        .page-wrapper {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px 0 60px;
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-header .overline {
            font-family: 'Inter', sans-serif;
            font-size: .78rem;
            letter-spacing: 2px;
            color: var(--gold);
            text-transform: uppercase;
            font-weight: 600;
        }

        .page-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--dark);
            margin: 6px 0 10px;
        }

        .page-header p {
            font-family: 'Inter', sans-serif;
            color: #999;
            font-size: .95rem;
        }

        /* Filtros */
        .filter-bar {
            background: var(--white);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 24px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .05);
            border: 1px solid var(--border);
        }

        .filter-bar select,
        .filter-bar input {
            padding: 9px 14px;
            border: 1.5px solid #e8e0d6;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: .88rem;
            background: var(--cream);
            color: var(--dark);
            outline: none;
        }

        .filter-bar select:focus,
        .filter-bar input:focus {
            border-color: var(--gold);
        }

        .filter-count {
            margin-left: auto;
            font-family: 'Inter', sans-serif;
            font-size: .85rem;
            color: #aaa;
        }

        .filter-count span {
            font-weight: 700;
            color: var(--gold);
        }

        /* Grid de tarjetas */
        .favs-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        /* Tarjeta propiedad */
        .prop-card {
            background: var(--white);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, .07);
            border: 1px solid var(--border);
            transition: transform .2s, box-shadow .2s;
            position: relative;
        }

        .prop-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, .12);
        }

        .prop-card-img {
            position: relative;
            height: 180px;
            overflow: hidden;
            background: #f0ebe3;
        }

        .prop-card-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform .3s;
        }

        .prop-card:hover .prop-card-img img {
            transform: scale(1.04);
        }

        .prop-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 10px;
            border-radius: 20px;
            font-family: 'Inter', sans-serif;
            font-size: .72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .badge-venta {
            background: rgba(59, 130, 246, .9);
            color: #fff;
        }

        .badge-arriendo {
            background: rgba(16, 185, 129, .9);
            color: #fff;
        }

        .badge-temporal {
            background: rgba(245, 158, 11, .9);
            color: #fff;
        }

        .btn-quitar {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, .9);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f43f5e;
            font-size: .9rem;
            transition: background .2s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
        }

        .btn-quitar:hover {
            background: #fff;
            transform: scale(1.1);
        }

        .prop-body {
            padding: 16px;
        }

        .prop-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.05rem;
            color: var(--dark);
            margin: 0 0 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .prop-loc {
            font-family: 'Inter', sans-serif;
            font-size: .8rem;
            color: #aaa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .prop-price {
            font-family: 'Inter', sans-serif;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 12px;
        }

        .prop-specs {
            display: flex;
            gap: 12px;
            font-family: 'Inter', sans-serif;
            font-size: .78rem;
            color: #999;
            border-top: 1px solid #f5f5f5;
            padding-top: 10px;
        }

        .prop-specs span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .prop-specs i {
            color: var(--gold);
            font-size: .75rem;
        }

        .prop-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-ver {
            flex: 1;
            padding: 9px;
            background: var(--dark);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: .82rem;
            font-weight: 600;
            cursor: pointer;
            transition: background .2s;
            text-decoration: none;
            text-align: center;
        }

        .btn-ver:hover {
            background: #5a4a3f;
            color: #fff;
        }

        .btn-wa {
            padding: 9px 12px;
            background: #25D366;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: .85rem;
            transition: background .2s;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .btn-wa:hover {
            background: #1ebe59;
            color: #fff;
        }

        /* Estado vacÃ­o */
        .empty-state {
            grid-column: 1/-1;
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 3.5rem;
            color: #e8e0d6;
            display: block;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .empty-state p {
            font-family: 'Inter', sans-serif;
            color: #aaa;
            margin-bottom: 20px;
        }

        .btn-explorar {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--gold);
            color: #fff;
            padding: 11px 24px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: .9rem;
            text-decoration: none;
            transition: background .2s;
        }

        .btn-explorar:hover {
            background: var(--gold-light);
            color: #fff;
        }

        /* Modal */
        .prop-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .prop-modal-overlay.open {
            display: flex;
        }

        .prop-modal {
            background: #fff;
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .prop-modal-header {
            position: relative;
        }

        .prop-modal-header img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 16px 16px 0 0;
        }

        .prop-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, .5);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prop-modal-body {
            padding: 24px;
        }

        .prop-modal-body h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 6px;
        }

        .prop-modal-body .modal-price {
            font-family: 'Inter', sans-serif;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 14px;
        }

        .modal-specs-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .modal-spec {
            background: var(--cream);
            padding: 10px 14px;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: .85rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-spec i {
            color: var(--gold);
        }

        .modal-desc {
            font-family: 'Inter', sans-serif;
            font-size: .9rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-cta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-cta a {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: .9rem;
            text-decoration: none;
            min-width: 140px;
        }

        .modal-cta .btn-dark {
            background: var(--dark);
            color: #fff;
        }

        .modal-cta .btn-green {
            background: #25D366;
            color: #fff;
        }

        /* Loading */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0ebe3 25%, #e8e0d6 50%, #f0ebe3 75%);
            background-size: 400% 100%;
            animation: shimmer 1.4s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 100% 0
            }

            100% {
                background-position: -100% 0
            }
        }

        @media(max-width:900px) {
            .favs-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media(max-width:600px) {
            .favs-grid {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>

<body data-page="cliente-favoritos">
    <div class="sidebar"></div>
    <div class="main-content">
        <div class="page-wrapper container">

            <div class="page-header">
                <span class="overline">Tu SelecciÃ³n</span>
                <h1><i class="fas fa-heart" style="color:var(--gold);font-size:.85em;margin-right:8px;"></i>Mis
                    Propiedades Favoritas</h1>
                <p>Las propiedades que guardaste para revisarlas con calma.</p>
            </div>

            <!-- Filtros -->
            <div class="filter-bar">
                <select id="filtro-op">
                    <option value="">Todas las operaciones</option>
                    <option value="Venta">Venta</option>
                    <option value="Arriendo">Arriendo</option>
                    <option value="Arriendo Temporal">Temporal</option>
                </select>
                <select id="filtro-tipo">
                    <option value="">Todos los tipos</option>
                    <option value="Casa">Casa</option>
                    <option value="Departamento">Departamento</option>
                    <option value="Terreno">Terreno</option>
                </select>
                <input type="text" id="filtro-buscar" placeholder="ðŸ”  Buscar por nombre o comuna...">
                <div class="filter-count"><span id="count-num">0</span> favoritos</div>
            </div>

            <!-- Grid de propiedades -->
            <div class="favs-grid" id="favs-grid">
                <div class="empty-state">
                    <div style="height:20px;width:60%;margin:0 auto 12px; border-radius:6px;" class="loading-skeleton">
                    </div>
                    <div style="height:14px;width:40%;margin:0 auto;" class="loading-skeleton"></div>
                </div>
            </div>
        </div>
        <div id="footer-placeholder"></div>
    </div>

    <!-- Modal detalle -->
    <div class="prop-modal-overlay" id="prop-modal">
        <div class="prop-modal">
            <div class="prop-modal-header">
                <img id="modal-img" src="" alt="">
                <button class="prop-modal-close" onclick="cerrarModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="prop-modal-body">
                <span id="modal-badge" class="prop-badge" style="margin-bottom:8px;display:inline-block;"></span>
                <h2 id="modal-title"></h2>
                <div class="modal-price" id="modal-price"></div>
                <div class="modal-specs-row" id="modal-specs"></div>
                <p class="modal-desc" id="modal-desc"></p>
                <div class="modal-cta">
                    <a href="#" id="modal-ficha" class="btn-dark" target="_blank"><i
                            class="fas fa-external-link-alt"></i> Ver ficha completa</a>
                    <a href="#" id="modal-wa" class="btn-green" target="_blank"><i class="fab fa-whatsapp"></i>
                        Consultar</a>
                </div>
            </div>
        </div>
    </div>

    <script src="js/client-sidebar.js"></script>
    <script src="cargador.js"></script>
    <script type="module" src="script.js"></script>
    <script>
        (function () {
            let todasLasPropiedades = [];
            let filtradas = [];

            // â”€â”€ Cargar favoritos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async function cargarFavoritos() {
                const grid = document.getElementById('favs-grid');
                const ids = JSON.parse(localStorage.getItem('favoritos') || '[]');

                if (!ids.length) {
                    mostrarEmpty(grid);
                    return;
                }

                try {
                    const res = await fetch(`/api/propiedades/por-ids?ids=${ids.join(',')}`);
                    const data = await res.json();
                    todasLasPropiedades = data;
                    filtradas = [...data];
                    actualizarContador(data.length);
                    renderizarGrid(data, grid);
                } catch (e) {
                    grid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>Error al cargar</h3><p>No se pudo conectar con el servidor.</p></div>';
                }
            }

            function mostrarEmpty(grid) {
                actualizarContador(0);
                grid.innerHTML = `
            <div class="empty-state">
                <i class="far fa-heart"></i>
                <h3>Sin favoritos aÃºn</h3>
                <p>Explora nuestro catÃ¡logo y guarda las propiedades que mÃ¡s te gusten.</p>
                <a href="propiedades.html" class="btn-explorar"><i class="fas fa-search"></i> Explorar propiedades</a>
            </div>`;
            }

            function actualizarContador(n) {
                const el = document.getElementById('count-num');
                if (el) el.textContent = n;
            }

            function renderizarGrid(props, grid) {
                if (!props.length) {
                    grid.innerHTML = `<div class="empty-state"><i class="fas fa-filter"></i><h3>Sin resultados</h3><p>Prueba cambiando los filtros.</p></div>`;
                    return;
                }
                grid.innerHTML = props.map(p => tarjetaHTML(p)).join('');
            }

            function badgeClass(op) {
                if (!op) return 'badge-venta';
                const o = op.toLowerCase();
                if (o.includes('arriendo temporal') || o.includes('temporal')) return 'badge-temporal';
                if (o.includes('arriendo')) return 'badge-arriendo';
                return 'badge-venta';
            }

            function tarjetaHTML(p) {
                const img = p.images?.main || 'https://placehold.co/400x300/f9f7f2/bfa378?text=Sin+foto';
                const bc = badgeClass(p.operation);
                return `
        <div class="prop-card">
            <div class="prop-card-img">
                <img src="${img}" alt="${p.title}" loading="lazy" onerror="this.src='https://placehold.co/400x300/f9f7f2/bfa378?text=Sin+foto'">
                <span class="prop-badge ${bc}">${p.operation || 'Venta'}</span>
                <button class="btn-quitar" title="Quitar de favoritos" onclick="quitarFavorito(${p.id}, this)">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
            <div class="prop-body">
                <div class="prop-title" title="${p.title}">${p.title}</div>
                <div class="prop-loc"><i class="fas fa-map-marker-alt"></i>${p.location || 'Consultar'}</div>
                <div class="prop-price">${p.price}</div>
                <div class="prop-specs">
                    ${p.specs?.dorms ? `<span><i class="fas fa-bed"></i>${p.specs.dorms} Dorm</span>` : ''}
                    ${p.specs?.baths ? `<span><i class="fas fa-bath"></i>${p.specs.baths} BaÃ±os</span>` : ''}
                    ${p.specs?.m2Util ? `<span><i class="fas fa-ruler-combined"></i>${p.specs.m2Util} mÂ²</span>` : ''}
                </div>
                <div class="prop-actions">
                    <button class="btn-ver" onclick="abrirModal(${p.id})"><i class="fas fa-eye"></i> Ver detalle</button>
                    <a class="btn-wa" href="https://wa.me/56952286689?text=Hola%2C%20me%20interesa%20${encodeURIComponent(p.title)}" target="_blank" rel="noopener"><i class="fab fa-whatsapp"></i></a>
                </div>
            </div>
        </div>`;
            }

            // â”€â”€ Quitar favorito â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            window.quitarFavorito = function (id, btn) {
                const favs = JSON.parse(localStorage.getItem('favoritos') || '[]').filter(f => f != id);
                localStorage.setItem('favoritos', JSON.stringify(favs));
                const card = btn.closest('.prop-card');
                card.style.transition = 'opacity .3s, transform .3s';
                card.style.opacity = '0';
                card.style.transform = 'scale(.95)';
                setTimeout(() => {
                    todasLasPropiedades = todasLasPropiedades.filter(p => p.id != id);
                    aplicarFiltros();
                }, 300);
            };

            // â”€â”€ Filtros â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            function aplicarFiltros() {
                const op = document.getElementById('filtro-op').value.toLowerCase();
                const tipo = document.getElementById('filtro-tipo').value.toLowerCase();
                const busca = document.getElementById('filtro-buscar').value.toLowerCase();
                filtradas = todasLasPropiedades.filter(p => {
                    const passOp = !op || (p.operation || '').toLowerCase().includes(op);
                    const passTipo = !tipo || (p.type || '').toLowerCase().includes(tipo);
                    const passBusc = !busca || (p.title || '').toLowerCase().includes(busca) || (p.location || '').toLowerCase().includes(busca);
                    return passOp && passTipo && passBusc;
                });
                actualizarContador(filtradas.length);
                renderizarGrid(filtradas, document.getElementById('favs-grid'));
            }
            ['filtro-op', 'filtro-tipo', 'filtro-buscar'].forEach(id =>
                document.getElementById(id)?.addEventListener('input', aplicarFiltros)
            );

            // â”€â”€ Modal detalle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            window.abrirModal = function (id) {
                const p = todasLasPropiedades.find(x => x.id == id);
                if (!p) return;
                document.getElementById('modal-img').src = p.images?.main || '';
                document.getElementById('modal-title').textContent = p.title;
                document.getElementById('modal-price').textContent = p.price;
                document.getElementById('modal-desc').textContent = p.desc || 'Sin descripciÃ³n disponible.';
                const badge = document.getElementById('modal-badge');
                badge.textContent = p.operation || '';
                badge.className = `prop-badge ${badgeClass(p.operation)}`;

                const specs = document.getElementById('modal-specs');
                specs.innerHTML = [
                    p.specs?.dorms ? `<div class="modal-spec"><i class="fas fa-bed"></i>${p.specs.dorms} Dormitorios</div>` : '',
                    p.specs?.baths ? `<div class="modal-spec"><i class="fas fa-bath"></i>${p.specs.baths} BaÃ±os</div>` : '',
                    p.specs?.m2Util ? `<div class="modal-spec"><i class="fas fa-ruler-combined"></i>${p.specs.m2Util} mÂ² Ãºtiles</div>` : '',
                    p.specs?.m2Total ? `<div class="modal-spec"><i class="fas fa-expand"></i>${p.specs.m2Total} mÂ² totales</div>` : '',
                    p.location ? `<div class="modal-spec"><i class="fas fa-map-marker-alt"></i>${p.location}</div>` : ''
                ].join('');

                document.getElementById('modal-ficha').href = `web-ficha.html?id=${p.id}`;
                document.getElementById('modal-wa').href = `https://wa.me/56952286689?text=Hola%2C%20me%20interesa%20la%20propiedad%20${encodeURIComponent(p.title)}`;

                document.getElementById('prop-modal').classList.add('open');
            };

            window.cerrarModal = function () {
                document.getElementById('prop-modal').classList.remove('open');
            };
            document.getElementById('prop-modal').addEventListener('click', function (e) {
                if (e.target === this) cerrarModal();
            });

            cargarFavoritos();
        })();
    </script>
</body>

</html>