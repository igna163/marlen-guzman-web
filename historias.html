<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historias que nos Mueven | Marlen Guzmán</title>
    <link rel="icon" href="Logo_MG.jpeg" type="image/jpeg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-light">

    <div id="nav-placeholder"></div>

    <header class="position-relative text-white text-center py-5"
        style="margin-top: 80px; background: url('img/background-historias.png') center/cover no-repeat; min-height: 400px; display: flex; align-items: center;">

        <div class="position-absolute top-0 start-0 w-100 h-100" style="background: rgba(44, 62, 80, 0.6);"></div>

        <div class="container position-relative z-1">
            <h1 class="display-4 fw-bold mb-3">Historias que nos mueven</h1>
            <p class="lead mx-auto w-75 d-none d-md-block">
                Detrás de cada llave entregada, hay un sueño cumplido, una familia que crece o un nuevo comienzo.
                Aquí compartimos los momentos que dan sentido a nuestro trabajo.
            </p>
        </div>
    </header>

    <div class="container my-5">
        <div class="row g-5">

            <div class="col-lg-7">
                <div class="mb-4 border-bottom pb-2">
                    <h3 class="fw-bold" style="color: #2c3e50;">Experiencias en el Valle</h3>
                </div>

                <div id="historias-container">
                    <div class="text-center py-5">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card border-0 shadow p-4" style="background-color: #fff;">
                    <div class="text-center mb-4">
                        <span class="badge bg-warning text-dark mb-2">Tu opinión nos importa</span>
                        <h3 class="fw-bold" style="color: #2c3e50;">Comparte tu Historia</h3>
                        <p class="small text-muted">Ayuda a otras familias a encontrar la confianza que necesitan.</p>
                    </div>

                    <form id="formHistoria" onsubmit="enviarHistoria(event)">
                        <div class="mb-3">
                            <label class="form-label fw-bold small">Tu Nombre / Familia</label>
                            <input type="text" class="form-control" placeholder="Ej: Familia González" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">¿Qué servicio realizaste?</label>
                            <select class="form-select">
                                <option>Compré una propiedad</option>
                                <option>Vendí mi propiedad</option>
                                <option>Arrendé una propiedad</option>
                                <option>Servicio de Remodelación</option>
                                <option>Energía Solar</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Título de tu historia</label>
                            <input type="text" class="form-control" placeholder="Ej: ¡Un sueño hecho realidad!"
                                required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Cuéntanos tu experiencia</label>
                            <textarea class="form-control" rows="4"
                                placeholder="¿Cómo te sentiste? ¿Qué fue lo que más destacas?" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small">Foto (Opcional)</label>
                            <input type="file" class="form-control form-control-sm">
                            <div class="form-text small">Una foto de tu nuevo hogar o del proceso.</div>
                        </div>

                        <div class="mb-4 text-center">
                            <label class="form-label fw-bold small d-block">Tu valoración</label>
                            <div class="rating-stars" style="color: #ffc107; font-size: 1.5rem; cursor: pointer;">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-dark w-100 py-3 fw-bold rounded-pill shadow-sm">
                            ENVIAR MI HISTORIA <i class="fas fa-paper-plane ms-2"></i>
                        </button>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="cargador.js"></script>
    <script src="script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', cargarHistorias);

        async function cargarHistorias() {
            try {
                const res = await fetch('/api/historias');
                const json = await res.json();

                const container = document.getElementById('historias-container');
                container.innerHTML = ''; // Limpiar spinner

                if (!json.success || json.data.length === 0) {
                    container.innerHTML = '<p class="text-muted">Aún no hay historias publicadas.</p>';
                    return;
                }

                json.data.forEach(h => {
                    // Generar estrellas dinámicamente
                    let estrellas = '';
                    for (let i = 0; i < h.valoracion; i++) { estrellas += '<i class="fas fa-star"></i>'; }

                    // Imagen por defecto si no hay foto
                    const img = h.foto_url || 'https://images.unsplash.com/photo-1517841905240-472988babdf9?auto=format&fit=crop&q=80';

                    const html = `
                    <div class="card border-0 shadow-sm mb-4 animate-up">
                        <div class="row g-0 align-items-center">
                            <div class="col-md-4">
                                <img src="${img}" class="img-fluid rounded-start h-100" style="object-fit: cover; min-height: 200px; width:100%;" alt="Cliente Feliz">
                            </div>
                            <div class="col-md-8">
                                <div class="card-body p-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h5 class="card-title fw-bold text-dark">"${h.titulo_historia}"</h5>
                                        <div class="text-warning small">${estrellas}</div>
                                    </div>
                                    <p class="card-text text-muted fst-italic">"${h.testimonio}"</p>
                                    <div class="d-flex align-items-center mt-3">
                                        <div class="bg-light rounded-circle p-2 me-2 text-primary"><i class="fas fa-user"></i></div>
                                        <div>
                                            <p class="mb-0 fw-bold small text-dark">${h.nombre_cliente}</p>
                                            <p class="mb-0 small text-muted">${h.servicio_realizado}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });

            } catch (error) {
                console.error("Error:", error);
            }
        }

        // Lógica para enviar el formulario (Conexión REAL)
        async function enviarHistoria(e) {
            e.preventDefault();
            // Capturar datos del formulario...
            // (Aquí conectaríamos con el endpoint POST /api/historias que creamos arriba)
            alert("✨ ¡Gracias! Tu historia se ha enviado y está pendiente de aprobación.");
            e.target.reset();
        }
    </script>
</body>

</html>